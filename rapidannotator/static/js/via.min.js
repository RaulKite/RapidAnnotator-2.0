var _via_current_image_filename,_via_current_image,_via_current_image_width,_via_current_image_height,_via_reg_ctx,_via_canvas_width,_via_canvas_height,_via_region_click_x,_via_region_click_y,_via_paste_to_multiple_images_input,_via_message_clear_timer,_ra_initialized=!1;function _ra_via_init(a=5){for(index=0,_ra_initialized=!0;index<a;index++)_via_reg_canvas=document.getElementById(RA_CANVAS_NAME+index),_via_current_image=document.getElementById(RA_IMAGE_NAME+index),_via_init_reg_canvas_context(),_via_init_keyboard_handlers(),_via_init_mouse_handlers()}function _ra_via_update(a){_ra_initialized||_ra_via_init(),a=a.toString(),_via_reg_canvas=document.getElementById(RA_CANVAS_NAME+a),_via_current_image=document.getElementById(RA_IMAGE_NAME+a),_via_current_image.classList.add("visible"),_via_init_reg_canvas_context(),_via_show_img_from_buffer(a)}function _via_basic_demo_define_annotations(){}"use strict";const RA_IMAGE_WIDTH=350,RA_IMAGE_HEIGHT=420,RA_CANVAS_NAME="region-canvas-",RA_IMAGE_NAME="region-image-";var VIA_REGION_SHAPE={RECT:"rect",CIRCLE:"circle",ELLIPSE:"ellipse",POLYGON:"polygon",POINT:"point",POLYLINE:"polyline",NONE:"none"},VIA_DISPLAY_AREA_CONTENT_NAME={IMAGE:"image_panel",IMAGE_GRID:"image_grid_panel",SETTINGS:"settings_panel",PAGE_404:"page_404",PAGE_GETTING_STARTED:"page_getting_started",PAGE_ABOUT:"page_about",PAGE_START_INFO:"page_start_info",PAGE_LICENSE:"page_license"},VIA_ANNOTATION_EDITOR_MODE={SINGLE_REGION:"single_region",ALL_REGIONS:"all_regions"},VIA_ANNOTATION_EDITOR_PLACEMENT={NEAR_REGION:"NEAR_REGION",IMAGE_BOTTOM:"IMAGE_BOTTOM",DISABLE:"DISABLE"},VIA_REGION_EDGE_TOL=5,VIA_REGION_CONTROL_POINT_SIZE=2,VIA_POLYGON_VERTEX_MATCH_TOL=5,VIA_REGION_MIN_DIM=3,VIA_MOUSE_CLICK_TOL=2,VIA_ELLIPSE_EDGE_TOL=.2,VIA_THETA_TOL=Math.PI/18,VIA_POLYGON_RESIZE_VERTEX_OFFSET=100,VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX=3,VIA_CANVAS_ZOOM_LEVELS=[.25,.5,.75,1,1.5,2,2.5,3,4,5,6,7,8,9,10],VIA_REGION_COLOR_LIST=["#E69F00","#56B4E9","#009E73","#D55E00","#CC79A7","#F0E442","#ffffff"],VIA_REGION_SHAPES_POINTS_RADIUS=3,VIA_REGION_POINT_RADIUS=3,VIA_REGION_POINT_RADIUS_DEFAULT=3,VIA_THEME_REGION_BOUNDARY_WIDTH=3,VIA_THEME_BOUNDARY_LINE_COLOR="black",VIA_THEME_BOUNDARY_FILL_COLOR="yellow",VIA_THEME_SEL_REGION_FILL_COLOR="#808080",VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR="yellow",VIA_THEME_SEL_REGION_OPACITY=.5,VIA_THEME_MESSAGE_TIMEOUT_MS=6e3,VIA_THEME_CONTROL_POINT_COLOR="#ff0000",VIA_CSV_SEP=",",VIA_CSV_QUOTE_CHAR='"',VIA_CSV_KEYVAL_SEP=":",_ra_regions=[],_via_img_src={},_via_img_fileref={},_via_img_count=0,_via_canvas_regions=[],_via_canvas_scale=1,_via_image_id="",_via_image_index=-1,_via_img_stat={},_via_is_all_img_stat_read_ongoing=!1,_via_img_stat_current_img_index=!1,_via_display_area=document.getElementById("display_area"),_via_reg_canvas=document.getElementById(RA_CANVAS_NAME+"0"),_via_canvas_zoom_level_index=VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX,_via_canvas_scale_without_zoom=1,_via_is_user_drawing_region=!1,_via_current_image_loaded=!0,_via_is_window_resized=!1,_via_is_user_resizing_region=!1,_via_is_user_moving_region=!1,_via_is_user_drawing_polygon=!1,_via_is_region_selected=!1,_via_is_all_region_selected=!1,_via_is_loaded_img_list_visible=!1,_via_is_attributes_panel_visible=!1,_via_is_reg_attr_panel_visible=!1,_via_is_file_attr_panel_visible=!1,_via_is_canvas_zoomed=!1,_via_is_loading_current_image=!1,_via_is_region_id_visible=!0,_via_is_region_boundary_visible=!0,_via_is_region_info_visible=!1,_via_is_ctrl_pressed=!1,_via_is_debug_mode=!1,_via_is_message_visible=!0,_via_current_shape=VIA_REGION_SHAPE.NONE,_via_current_polygon_region_id=-1,_via_user_sel_region_id=-1,_via_click_x0=0,_via_click_y0=0,_via_click_x1=0,_via_click_y1=0,_via_region_edge=[-1,-1],_via_current_x=0,_via_current_y=0,_via_region_selected_flag=[],_via_copied_image_regions=[],_via_attribute_being_updated="region",_via_attributes={region:{},file:{}},_via_current_attribute_id="",_via_canvas_regions_group_color={},_via_user_input_ok_handler=null,_via_user_input_cancel_handler=null,_via_user_input_data={},_via_annotaion_editor_panel=document.getElementById("annotation_editor_panel"),_via_metadata_being_updated="region",_via_annotation_editor_mode=VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION,_via_is_local_storage_available=!1,_via_is_save_ongoing=!1,_via_image_id_list=[],_via_image_filename_list=[],_via_image_load_error=[],_via_image_filepath_resolved=[],_via_image_filepath_id_list=[],_via_reload_img_fn_list_table=!0,_via_img_fn_list_img_index_list=[],_via_img_fn_list_html=[],image_grid_panel=document.getElementById("image_grid_panel"),_via_display_area_content_name="",_via_display_area_content_name_prev="",_via_image_grid_requires_update=!1,_via_image_grid_content_overflow=!1,_via_image_grid_load_ongoing=!1,_via_image_grid_page_first_index=0,_via_image_grid_page_last_index=-1,_via_image_grid_selected_img_index_list=[],_via_image_grid_page_img_index_list=[],_via_image_grid_visible_img_index_list=[],_via_image_grid_mousedown_img_index=-1,_via_image_grid_mouseup_img_index=-1,_via_image_grid_img_index_list=[],_via_image_grid_region_index_list=[],_via_image_grid_group={},_via_image_grid_group_var=[],_via_image_grid_group_show_all=!1,_via_image_grid_stack_prev_page=[],VIA_IMG_PRELOAD_INDICES=[1,-1,2,3,-2,4],VIA_IMG_PRELOAD_COUNT=4,_via_buffer_preload_img_index=-1,_via_buffer_img_index_list=[],_via_buffer_img_shown_timestamp=[],_via_preload_img_promise_list=[],_via_settings={};_via_settings.ui={},_via_settings.ui.annotation_editor_height=25,_via_settings.ui.annotation_editor_fontsize=.8,_via_settings.ui.leftsidebar_width=18,_via_settings.ui.image_grid={},_via_settings.ui.image_grid.img_height=80,_via_settings.ui.image_grid.rshape_fill="none",_via_settings.ui.image_grid.rshape_fill_opacity=.3,_via_settings.ui.image_grid.rshape_stroke="yellow",_via_settings.ui.image_grid.rshape_stroke_width=2,_via_settings.ui.image_grid.show_region_shape=!0,_via_settings.ui.image_grid.show_image_policy="all",_via_settings.ui.image={},_via_settings.ui.image.region_label="__via_region_id__",_via_settings.ui.image.region_color="__via_default_region_color__",_via_settings.ui.image.region_label_font="10px Sans",_via_settings.ui.image.on_image_annotation_editor_placement=VIA_ANNOTATION_EDITOR_PLACEMENT.NEAR_REGION,_via_settings.core={},_via_settings.core.buffer_size=4*VIA_IMG_PRELOAD_COUNT+2,_via_settings.core.filepath={},_via_settings.core.default_filepath="";var invisible_file_input=document.getElementById("invisible_file_input"),display_area=document.getElementById("display_area"),image_panel=document.getElementById("image_panel"),img_buffer_now=document.getElementById("img_buffer_now"),annotation_list_snippet=document.getElementById("annotation_list_snippet"),annotation_textarea=document.getElementById("annotation_textarea"),img_fn_list_panel=document.getElementById("img_fn_list_panel"),img_fn_list=document.getElementById("img_fn_list"),attributes_panel=document.getElementById("attributes_panel"),BBOX_LINE_WIDTH=4,BBOX_SELECTED_OPACITY=.3,BBOX_BOUNDARY_FILL_COLOR_ANNOTATED="#f2f2f2",BBOX_BOUNDARY_FILL_COLOR_NEW="#aaeeff",BBOX_BOUNDARY_LINE_COLOR="#1a1a1a",BBOX_SELECTED_FILL_COLOR="#ffffff",VIA_ANNOTATION_EDITOR_HEIGHT_CHANGE=5,VIA_ANNOTATION_EDITOR_FONTSIZE_CHANGE=.1,VIA_IMAGE_GRID_IMG_HEIGHT_CHANGE=20,VIA_LEFTSIDEBAR_WIDTH_CHANGE=1,VIA_POLYGON_SEGMENT_SUBTENDED_ANGLE=5,VIA_FLOAT_PRECISION=3,VIA_COCO_EXPORT_RSHAPE=["rect","circle","ellipse","polygon","point"];function file_region(){this.shape_attributes={},this.region_attributes={}}function _via_init(){_via_init_reg_canvas_context(),_via_init_keyboard_handlers(),_via_init_mouse_handlers()}function _via_init_reg_canvas_context(){_via_reg_ctx=_via_reg_canvas.getContext("2d")}function _via_init_keyboard_handlers(){window.addEventListener("keydown",_via_window_keydown_handler,!1),_via_reg_canvas.addEventListener("keydown",_via_reg_canvas_keydown_handler,!1),_via_reg_canvas.addEventListener("keyup",_via_reg_canvas_keyup_handler,!1)}function _via_init_mouse_handlers(){_via_reg_canvas.addEventListener("dblclick",_via_reg_canvas_dblclick_handler,!1),_via_reg_canvas.addEventListener("mousedown",_via_reg_canvas_mousedown_handler,!1),_via_reg_canvas.addEventListener("mouseup",_via_reg_canvas_mouseup_handler,!1),_via_reg_canvas.addEventListener("mouseover",_via_reg_canvas_mouseover_handler,!1),_via_reg_canvas.addEventListener("mousemove",_via_reg_canvas_mousemove_handler,!1),_via_reg_canvas.addEventListener("wheel",_via_reg_canvas_mouse_wheel_listener,!1),_via_reg_canvas.addEventListener("touchstart",_via_reg_canvas_mousedown_handler,!1),_via_reg_canvas.addEventListener("touchend",_via_reg_canvas_mouseup_handler,!1),_via_reg_canvas.addEventListener("touchmove",_via_reg_canvas_mousemove_handler,!1)}function map_to_json(b){var c=[];for(var d in b){var e=b[d],a=JSON.stringify(d);a+=VIA_CSV_KEYVAL_SEP,a+=JSON.stringify(e),c.push(a)}return"{"+c.join(VIA_CSV_SEP)+"}"}function escape_for_csv(a){return a.replace(/["]/g,'""')}function unescape_from_csv(a){return a.replace(/""/g,'"')}function remove_prefix_suffix_quotes(a){return'"'===a.charAt(0)&&'"'===a.charAt(a.length-1)?a.substr(1,a.length-2):a}function clone_image_region(b){var c=new file_region;for(var a in b.shape_attributes)c.shape_attributes[a]=clone_value(b.shape_attributes[a]);for(var a in b.region_attributes)c.region_attributes[a]=clone_value(b.region_attributes[a]);return c}function clone_value(a){if("object"==typeof a){if(Array.isArray(a))return a.slice(0);var c={};for(var b in a)a.hasOwnProperty(b)&&(c[b]=clone_value(a[b]));return c}return a}function _via_get_image_id(a,b){return void 0===b?a:a+b}function save_data_to_local_file(b,c){var a=document.createElement("a");a.href=URL.createObjectURL(b),a.download=c;var d=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(d)}function init_message_panel(){var a=document.getElementById("message_panel");a.addEventListener("mousedown",function(){this.style.display="none"},!1),a.addEventListener("mouseover",function(){clearTimeout(_via_message_clear_timer)},!1)}function toggle_message_visibility(){_via_is_message_visible?(show_message("Disabled status messages"),_via_is_message_visible=!1):(_via_is_message_visible=!0,show_message("Status messages are now visible"))}function show_message(c,a){if(_via_message_clear_timer&&clearTimeout(_via_message_clear_timer),_via_is_message_visible){var b=a;void 0===a&&(b=VIA_THEME_MESSAGE_TIMEOUT_MS),document.getElementById("message_panel_content").innerHTML=c,document.getElementById("message_panel").style.display="block",_via_message_clear_timer=setTimeout(function(){document.getElementById("message_panel").style.display="none"},b)}}function _via_regions_group_color_init(){_via_canvas_regions_group_color={};var c=_via_settings.ui.image.region_color;if("__via_default_region_color__"!==c){for(var a,b=0;b<_ra_regions.length;++b)_via_canvas_regions_group_color[a=_ra_regions[b].region_attributes[c]]=1;var d=0;for(a in _via_canvas_regions_group_color)_via_canvas_regions_group_color[a]=VIA_REGION_COLOR_LIST[d%VIA_REGION_COLOR_LIST.length],d+=1}}function _via_load_canvas_regions(){_via_regions_group_color_init();var b=_ra_regions;_via_canvas_regions=[];for(var a=0;a<b.length;++a){var h=new file_region;for(var i in b[a].shape_attributes)h.shape_attributes[i]=b[a].shape_attributes[i];switch(_via_canvas_regions.push(h),_via_canvas_regions[a].shape_attributes.name){case VIA_REGION_SHAPE.RECT:var j=b[a].shape_attributes.x/_via_canvas_scale,k=b[a].shape_attributes.y/_via_canvas_scale,l=b[a].shape_attributes.width/_via_canvas_scale,m=b[a].shape_attributes.height/_via_canvas_scale;_via_canvas_regions[a].shape_attributes.x=Math.round(j),_via_canvas_regions[a].shape_attributes.y=Math.round(k),_via_canvas_regions[a].shape_attributes.width=Math.round(l),_via_canvas_regions[a].shape_attributes.height=Math.round(m);break;case VIA_REGION_SHAPE.CIRCLE:var d=b[a].shape_attributes.cx/_via_canvas_scale,e=b[a].shape_attributes.cy/_via_canvas_scale,n=b[a].shape_attributes.r/_via_canvas_scale;_via_canvas_regions[a].shape_attributes.cx=Math.round(d),_via_canvas_regions[a].shape_attributes.cy=Math.round(e),_via_canvas_regions[a].shape_attributes.r=Math.round(n);break;case VIA_REGION_SHAPE.ELLIPSE:var d=b[a].shape_attributes.cx/_via_canvas_scale,e=b[a].shape_attributes.cy/_via_canvas_scale,o=b[a].shape_attributes.rx/_via_canvas_scale,p=b[a].shape_attributes.ry/_via_canvas_scale,q=b[a].shape_attributes.theta;_via_canvas_regions[a].shape_attributes.cx=Math.round(d),_via_canvas_regions[a].shape_attributes.cy=Math.round(e),_via_canvas_regions[a].shape_attributes.rx=Math.round(o),_via_canvas_regions[a].shape_attributes.ry=Math.round(p),_via_canvas_regions[a].shape_attributes.theta=q;break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:for(var f=b[a].shape_attributes.all_points_x.slice(0),g=b[a].shape_attributes.all_points_y.slice(0),c=0;c<f.length;++c)f[c]=Math.round(f[c]/_via_canvas_scale),g[c]=Math.round(g[c]/_via_canvas_scale);_via_canvas_regions[a].shape_attributes.all_points_x=f,_via_canvas_regions[a].shape_attributes.all_points_y=g;break;case VIA_REGION_SHAPE.POINT:var d=b[a].shape_attributes.cx/_via_canvas_scale,e=b[a].shape_attributes.cy/_via_canvas_scale;_via_canvas_regions[a].shape_attributes.cx=Math.round(d),_via_canvas_regions[a].shape_attributes.cy=Math.round(e)}}}function select_region_shape(b){for(var c in VIA_REGION_SHAPE){var a=document.getElementById("region_shape_"+VIA_REGION_SHAPE[c]);a.classList.remove("selected")}_via_current_shape=b;var a=document.getElementById("region_shape_"+_via_current_shape);switch(a.classList.add("selected"),_via_current_shape){case VIA_REGION_SHAPE.RECT:case VIA_REGION_SHAPE.CIRCLE:case VIA_REGION_SHAPE.ELLIPSE:show_message("Press single click and drag mouse to draw "+_via_current_shape+" region");break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:_via_is_user_drawing_polygon=!1,_via_current_polygon_region_id=-1,show_message("[Single Click] to define polygon/polyline vertices, [Backspace] to delete last vertex, [Enter] to finish, [Esc] to cancel drawing.");break;case VIA_REGION_SHAPE.POINT:show_message("Press single click to define points (or landmarks)");break;default:show_message("None shape selected!")}}function set_all_canvas_size(a,b){_via_reg_canvas.height=b,_via_reg_canvas.width=a,image_panel.style.height=b+"px",image_panel.style.width=a+"px"}function set_all_canvas_scale(a){_via_reg_ctx.scale(a,a)}function show_all_canvas(){image_panel.style.display="inline-block"}function hide_all_canvas(){image_panel.style.display="none"}function jump_to_image(a){!(_via_img_count<=0)&&(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID?a>=0&&a<_via_img_count&&(show_single_image_view(),_via_show_img(a)):a>=0&&a<_via_img_count&&_via_show_img(a))}function toggle_all_regions_selection(b){var a,c=_ra_regions.length;for(a=0,_via_region_selected_flag=[];a<c;++a)_via_region_selected_flag[a]=b;_via_is_all_region_selected=b,_via_annotation_editor_mode===VIA_ANNOTATION_EDITOR_MODE.ALL_REGIONS&&annotation_editor_clear_row_highlight()}function select_only_region(a){toggle_all_regions_selection(!1),set_region_select_state(a,!0),_via_is_region_selected=!0,_via_is_all_region_selected=!1,_via_user_sel_region_id=a}function set_region_select_state(a,b){_via_region_selected_flag[a]=b}function _via_reg_canvas_dblclick_handler(a){a.stopPropagation()}function _via_reg_canvas_mousedown_handler(a){a.stopPropagation(),_via_click_x0=a.offsetX,_via_click_y0=a.offsetY,_via_region_edge=is_on_region_corner(_via_click_x0,_via_click_y0);var b=is_inside_region(_via_click_x0,_via_click_y0);_via_is_region_selected?_via_region_edge[1]>0?_via_is_user_resizing_region||(_via_region_edge[0]!==_via_user_sel_region_id&&(_via_user_sel_region_id=_via_region_edge[0]),_via_is_user_resizing_region=!0):(is_inside_this_region(_via_click_x0,_via_click_y0,_via_user_sel_region_id)&&(_via_is_user_moving_region||(_via_is_user_moving_region=!0,_via_region_click_x=_via_click_x0,_via_region_click_y=_via_click_y0)),-1===b&&(_via_is_user_drawing_region=!0,_via_is_region_selected=!1,_via_user_sel_region_id=-1,toggle_all_regions_selection(!1))):-1===b?_via_current_shape!==VIA_REGION_SHAPE.POLYGON&&_via_current_shape!==VIA_REGION_SHAPE.POLYLINE&&_via_current_shape!==VIA_REGION_SHAPE.POINT&&(_via_is_user_drawing_region=!0):_via_is_user_drawing_region=!0}function _via_reg_canvas_mouseup_handler(m){if(m.stopPropagation(),_via_click_x1=m.offsetX,_via_click_y1=m.offsetY,_via_is_user_moving_region){_via_is_user_moving_region=!1,_via_reg_canvas.style.cursor="default";var I=Math.round(_via_click_x1-_via_region_click_x),J=Math.round(_via_click_y1-_via_region_click_y);if(Math.abs(I)>VIA_MOUSE_CLICK_TOL||Math.abs(J)>VIA_MOUSE_CLICK_TOL)_via_move_selected_regions(I,J);else{var x=is_inside_region(_via_click_x0,_via_click_y0,!0);if(x>=0&&x!==_via_user_sel_region_id)_via_user_sel_region_id=x,_via_is_region_selected=!0,_via_is_user_moving_region=!1,m.shiftKey||toggle_all_regions_selection(!1),set_region_select_state(x,!0);else switch(toggle_all_regions_selection(!1),_via_is_region_selected=!1,_via_current_shape){case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:_via_is_user_drawing_polygon=!0;var g=new file_region;g.shape_attributes.name=_via_current_shape,g.shape_attributes.all_points_x=[Math.round(_via_click_x0)],g.shape_attributes.all_points_y=[Math.round(_via_click_y0)];var B=_via_canvas_regions.push(g);_via_current_polygon_region_id=B-1;break;case VIA_REGION_SHAPE.POINT:var h=new file_region;h.shape_attributes.name=VIA_REGION_SHAPE.POINT,h.shape_attributes.cx=Math.round(_via_click_x0*_via_canvas_scale),h.shape_attributes.cy=Math.round(_via_click_y0*_via_canvas_scale),_ra_regions.push(h);var i=new file_region;i.shape_attributes.name=VIA_REGION_SHAPE.POINT,i.shape_attributes.cx=Math.round(_via_click_x0),i.shape_attributes.cy=Math.round(_via_click_y0),_via_canvas_regions.push(i)}}_via_redraw_reg_canvas(),_via_reg_canvas.focus();return}if(_via_is_user_resizing_region){_via_is_user_resizing_region=!1,_via_reg_canvas.style.cursor="default";var e=_via_region_edge[0],b=_ra_regions[e].shape_attributes,a=_via_canvas_regions[e].shape_attributes;switch(a.name){case VIA_REGION_SHAPE.RECT:var f=[a.x,a.y,0,0];f[2]=f[0]+a.width,f[3]=f[1]+a.height;var Z=_via_current_x,$=_via_current_y,K=!1;_via_is_ctrl_pressed&&(K=!0),rect_update_corner(_via_region_edge[1],f,Z,$,K),rect_standardize_coordinates(f);var _=Math.abs(f[2]-f[0]),aa=Math.abs(f[3]-f[1]);b.x=Math.round(f[0]*_via_canvas_scale),b.y=Math.round(f[1]*_via_canvas_scale),b.width=Math.round(_*_via_canvas_scale),b.height=Math.round(aa*_via_canvas_scale),a.x=Math.round(b.x/_via_canvas_scale),a.y=Math.round(b.y/_via_canvas_scale),a.width=Math.round(b.width/_via_canvas_scale),a.height=Math.round(b.height/_via_canvas_scale);break;case VIA_REGION_SHAPE.CIRCLE:var j=Math.abs(a.cx-_via_current_x),k=Math.abs(a.cy-_via_current_y),ab=Math.sqrt(j*j+k*k);b.r=fixfloat(ab*_via_canvas_scale),a.r=Math.round(b.r/_via_canvas_scale);break;case VIA_REGION_SHAPE.ELLIPSE:var C=a.rx,D=a.ry,s=a.theta,j=Math.abs(a.cx-_via_current_x),k=Math.abs(a.cy-_via_current_y);switch(_via_region_edge[1]){case 5:D=Math.sqrt(j*j+k*k),s=Math.atan2(-(_via_current_x-a.cx),_via_current_y-a.cy);break;case 6:C=Math.sqrt(j*j+k*k),s=Math.atan2(_via_current_y-a.cy,_via_current_x-a.cx);break;default:C=j,D=k,s=0}b.rx=fixfloat(C*_via_canvas_scale),b.ry=fixfloat(D*_via_canvas_scale),b.theta=fixfloat(s),a.rx=Math.round(b.rx/_via_canvas_scale),a.ry=Math.round(b.ry/_via_canvas_scale),a.theta=fixfloat(s);break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:var n=_via_region_edge[1]-VIA_POLYGON_RESIZE_VERTEX_OFFSET;if(m.ctrlKey||m.metaKey){var l=_via_canvas_regions[_via_user_sel_region_id].shape_attributes,ac=l.name,ad=is_on_polygon_vertex(l.all_points_x,l.all_points_y,_via_current_x,_via_current_y);if(ad===_via_region_edge[1])_via_polygon_del_vertex(e,n)&&show_message("Deleted vertex "+n+" from region");else{var L=is_on_polygon_edge(l.all_points_x,l.all_points_y,_via_current_x,_via_current_y);if(L===_via_region_edge[1]){var y=L-VIA_POLYGON_RESIZE_VERTEX_OFFSET,o=Math.round(_via_click_x1),p=Math.round(_via_click_y1),M=Math.round(o*_via_canvas_scale),N=Math.round(p*_via_canvas_scale);o=Math.round(M/_via_canvas_scale),p=Math.round(N/_via_canvas_scale),_via_canvas_regions[e].shape_attributes.all_points_x.splice(y+1,0,o),_via_canvas_regions[e].shape_attributes.all_points_y.splice(y+1,0,p),_ra_regions[e].shape_attributes.all_points_x.splice(y+1,0,M),_ra_regions[e].shape_attributes.all_points_y.splice(y+1,0,N),show_message("Added 1 new vertex to "+ac+" region")}}}else{var O=Math.round(_via_current_x*_via_canvas_scale),P=Math.round(_via_current_y*_via_canvas_scale);b.all_points_x[n]=O,b.all_points_y[n]=P,a.all_points_x[n]=Math.round(O/_via_canvas_scale),a.all_points_y[n]=Math.round(P/_via_canvas_scale)}}_via_redraw_reg_canvas(),_via_reg_canvas.focus();return}if(Math.abs(_via_click_x1-_via_click_x0)<VIA_MOUSE_CLICK_TOL||Math.abs(_via_click_y1-_via_click_y0)<VIA_MOUSE_CLICK_TOL){if(_via_is_user_drawing_polygon){var o=Math.round(_via_click_x1),p=Math.round(_via_click_y1),Q=_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_x.length,ae=_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_x[Q-1],af=_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_y[Q-1];(o!==ae||p!==af)&&(_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_x.push(o),_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_y.push(p))}else{var e=is_inside_region(_via_click_x0,_via_click_y0);if(e>=0){if(_via_user_sel_region_id=e,_via_is_region_selected=!0,_via_is_user_moving_region=!1,_via_is_user_drawing_region=!1,m.shiftKey||toggle_all_regions_selection(!1),set_region_select_state(e,!0),_via_is_region_info_visible){var a=_via_canvas_regions[e].shape_attributes;switch(a.name){case VIA_REGION_SHAPE.RECT:break;case VIA_REGION_SHAPE.CIRCLE:var E=document.getElementById("region_info"),z=_via_canvas_regions[_via_user_sel_region_id].shape_attributes;E.innerHTML+=", Radius:"+z.r;break;case VIA_REGION_SHAPE.ELLIPSE:var E=document.getElementById("region_info"),z=_via_canvas_regions[_via_user_sel_region_id].shape_attributes;E.innerHTML+=", X-radius:"+z.rx+", Y-radius:"+z.ry;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:}}show_message("Region selected. If you intended to draw a region, click again inside the selected region to start drawing a region.")}else if(_via_is_user_drawing_region)_via_is_user_drawing_region=!1,_via_is_region_selected=!1,toggle_all_regions_selection(!1);else switch(_via_current_shape){case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:_via_is_user_drawing_polygon=!0;var g=new file_region;g.shape_attributes.name=_via_current_shape,g.shape_attributes.all_points_x=[Math.round(_via_click_x0)],g.shape_attributes.all_points_y=[Math.round(_via_click_y0)];var B=_via_canvas_regions.push(g);_via_current_polygon_region_id=B-1;break;case VIA_REGION_SHAPE.POINT:var h=new file_region;h.shape_attributes.name=VIA_REGION_SHAPE.POINT,h.shape_attributes.cx=Math.round(_via_click_x0*_via_canvas_scale),h.shape_attributes.cy=Math.round(_via_click_y0*_via_canvas_scale),_ra_regions.push(h);var i=new file_region;i.shape_attributes.name=VIA_REGION_SHAPE.POINT,i.shape_attributes.cx=Math.round(_via_click_x0),i.shape_attributes.cy=Math.round(_via_click_y0),_via_canvas_regions.push(i)}}_via_redraw_reg_canvas(),_via_reg_canvas.focus();return}if(_via_is_user_drawing_region){_via_is_user_drawing_region=!1;var q=_via_click_x0,r=_via_click_y0,F=_via_click_x1,G=_via_click_y1,c=new file_region,d=new file_region,t=Math.abs(F-q),u=Math.abs(G-r),A=!1;if(t>VIA_REGION_MIN_DIM&&u>VIA_REGION_MIN_DIM){switch(_via_current_shape){case VIA_REGION_SHAPE.RECT:_via_click_x0<_via_click_x1?(q=_via_click_x0,F=_via_click_x1):(q=_via_click_x1,F=_via_click_x0),_via_click_y0<_via_click_y1?(r=_via_click_y0,G=_via_click_y1):(r=_via_click_y1,G=_via_click_y0);var R=Math.round(q*_via_canvas_scale),S=Math.round(r*_via_canvas_scale),T=Math.round(t*_via_canvas_scale),U=Math.round(u*_via_canvas_scale);c.shape_attributes.name="rect",c.shape_attributes.x=R,c.shape_attributes.y=S,c.shape_attributes.width=T,c.shape_attributes.height=U,d.shape_attributes.name="rect",d.shape_attributes.x=Math.round(R/_via_canvas_scale),d.shape_attributes.y=Math.round(S/_via_canvas_scale),d.shape_attributes.width=Math.round(T/_via_canvas_scale),d.shape_attributes.height=Math.round(U/_via_canvas_scale),A=!0;break;case VIA_REGION_SHAPE.CIRCLE:var v=Math.round(q*_via_canvas_scale),w=Math.round(r*_via_canvas_scale),l=Math.round(Math.sqrt(t*t+u*u)*_via_canvas_scale);c.shape_attributes.name="circle",c.shape_attributes.cx=v,c.shape_attributes.cy=w,c.shape_attributes.r=l,d.shape_attributes.name="circle",d.shape_attributes.cx=Math.round(v/_via_canvas_scale),d.shape_attributes.cy=Math.round(w/_via_canvas_scale),d.shape_attributes.r=Math.round(l/_via_canvas_scale),A=!0;break;case VIA_REGION_SHAPE.ELLIPSE:var v=Math.round(q*_via_canvas_scale),w=Math.round(r*_via_canvas_scale),V=Math.round(t*_via_canvas_scale),W=Math.round(u*_via_canvas_scale),X=0;c.shape_attributes.name="ellipse",c.shape_attributes.cx=v,c.shape_attributes.cy=w,c.shape_attributes.rx=V,c.shape_attributes.ry=W,c.shape_attributes.theta=X,d.shape_attributes.name="ellipse",d.shape_attributes.cx=Math.round(v/_via_canvas_scale),d.shape_attributes.cy=Math.round(w/_via_canvas_scale),d.shape_attributes.rx=Math.round(V/_via_canvas_scale),d.shape_attributes.ry=Math.round(W/_via_canvas_scale),d.shape_attributes.theta=X,A=!0;case VIA_REGION_SHAPE.POINT:case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:}if(A){var H=_ra_regions.push(c),Y=_via_canvas_regions.push(d);H!==Y&&console.log("_via_img_metadata.regions["+H+"] and _via_canvas_regions["+Y+"] count mismatch"),select_only_region(H-1)}_via_redraw_reg_canvas(),_via_reg_canvas.focus()}else show_message("Prevented accidental addition of a very small region.");return}}function _via_reg_canvas_mouseover_handler(a){_via_redraw_reg_canvas(),_via_reg_canvas.focus()}function _via_reg_canvas_mousemove_handler(r){if(_via_current_image_loaded){_via_current_x=r.offsetX,_via_current_y=r.offsetY;var b=document.getElementById("region_info");if(null!=b&&_via_is_region_info_visible){var z=Math.round(_via_current_x*_via_canvas_scale),A=Math.round(_via_current_y*_via_canvas_scale);b.innerHTML="X:"+z+", Y:"+A}if(_via_is_region_selected){if(null!=b&&_via_is_region_info_visible&& -1!==_via_user_sel_region_id){var B=_via_canvas_regions[_via_user_sel_region_id].shape_attributes;switch(B.name){case VIA_REGION_SHAPE.RECT:break;case VIA_REGION_SHAPE.CIRCLE:var b=document.getElementById("region_info"),a=_via_canvas_regions[_via_user_sel_region_id].shape_attributes;b.innerHTML+=", Radius:"+a.r;break;case VIA_REGION_SHAPE.ELLIPSE:var b=document.getElementById("region_info"),a=_via_canvas_regions[_via_user_sel_region_id].shape_attributes;b.innerHTML+=", X-radius:"+a.rx+", Y-radius:"+a.ry;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:}}if(!_via_is_user_resizing_region){if((_via_region_edge=is_on_region_corner(_via_current_x,_via_current_y))[0]===_via_user_sel_region_id){switch(_via_region_edge[1]){case 1:case 3:_via_reg_canvas.style.cursor="nwse-resize";break;case 2:case 4:_via_reg_canvas.style.cursor="nesw-resize";break;case 5:case 7:_via_reg_canvas.style.cursor="ns-resize";break;case 6:case 8:_via_reg_canvas.style.cursor="ew-resize";break;case 5:_via_reg_canvas.style.cursor="n-resize";break;case 6:_via_reg_canvas.style.cursor="e-resize";break;default:_via_reg_canvas.style.cursor="default"}_via_region_edge[1]>=VIA_POLYGON_RESIZE_VERTEX_OFFSET&&(_via_reg_canvas.style.cursor="crosshair",show_message("To move vertex, simply drag the vertex. To add vertex, press [Ctrl] key and click on the edge. To delete vertex, press [Ctrl] (or [Command]) key and click on vertex."))}else is_inside_this_region(_via_current_x,_via_current_y,_via_user_sel_region_id)?_via_reg_canvas.style.cursor="move":_via_reg_canvas.style.cursor="default"}}if(_via_is_user_drawing_region){_via_canvas_regions.length?_via_redraw_reg_canvas():_via_reg_ctx.clearRect(0,0,_via_reg_canvas.width,_via_reg_canvas.height);var f=_via_click_x0,g=_via_click_y0,c=Math.round(Math.abs(_via_current_x-_via_click_x0)),d=Math.round(Math.abs(_via_current_y-_via_click_y0));switch(_via_reg_ctx.strokeStyle=VIA_THEME_BOUNDARY_FILL_COLOR,_via_current_shape){case VIA_REGION_SHAPE.RECT:_via_click_x0<_via_current_x?_via_click_y0<_via_current_y?(f=_via_click_x0,g=_via_click_y0):(f=_via_click_x0,g=_via_current_y):_via_click_y0<_via_current_y?(f=_via_current_x,g=_via_click_y0):(f=_via_current_x,g=_via_current_y),_via_draw_rect_region(f,g,c,d,!1),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", W:"+c+", H:"+d);break;case VIA_REGION_SHAPE.CIRCLE:var s=Math.round(Math.sqrt(c*c+d*d));_via_draw_circle_region(f,g,s,!1),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", Radius:"+s);break;case VIA_REGION_SHAPE.ELLIPSE:_via_draw_ellipse_region(f,g,c,d,0,!1),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", X-radius:"+fixfloat(c)+", Y-radius:"+fixfloat(d));case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:}_via_reg_canvas.focus()}if(_via_is_user_resizing_region){_via_canvas_regions.length?_via_redraw_reg_canvas():_via_reg_ctx.clearRect(0,0,_via_reg_canvas.width,_via_reg_canvas.height);var a=_via_canvas_regions[_via_region_edge[0]].shape_attributes;switch(a.name){case VIA_REGION_SHAPE.RECT:var e=[a.x,a.y,0,0];e[2]=e[0]+a.width,e[3]=e[1]+a.height;var C=_via_current_x,D=_via_current_y,t=!1;_via_is_ctrl_pressed&&(t=!0),rect_update_corner(_via_region_edge[1],e,C,D,t),rect_standardize_coordinates(e);var u=Math.abs(e[2]-e[0]),v=Math.abs(e[3]-e[1]);_via_draw_rect_region(e[0],e[1],u,v,!0),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", W:"+u+", H:"+v);break;case VIA_REGION_SHAPE.CIRCLE:var c=Math.abs(a.cx-_via_current_x),d=Math.abs(a.cy-_via_current_y),w=Math.sqrt(c*c+d*d);if(_via_draw_circle_region(a.cx,a.cy,w,!0),null!=b&&_via_is_region_info_visible){var i=b.innerHTML.split(",");b.innerHTML="",b.innerHTML+=i[0]+","+i[1]+", Radius:"+Math.round(w)}break;case VIA_REGION_SHAPE.ELLIPSE:var m=a.rx,n=a.ry,o=a.theta,c=Math.abs(a.cx-_via_current_x),d=Math.abs(a.cy-_via_current_y);switch(_via_region_edge[1]){case 5:n=Math.sqrt(c*c+d*d),o=Math.atan2(-(_via_current_x-a.cx),_via_current_y-a.cy);break;case 6:m=Math.sqrt(c*c+d*d),o=Math.atan2(_via_current_y-a.cy,_via_current_x-a.cx);break;default:m=c,n=d,o=0}if(_via_draw_ellipse_region(a.cx,a.cy,m,n,o,!0),null!=b&&_via_is_region_info_visible){var i=b.innerHTML.split(",");b.innerHTML="",b.innerHTML=i[0]+","+i[1]+", X-radius:"+fixfloat(m)+", Y-radius:"+fixfloat(n)}break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:var h=a.all_points_x.slice(0),j=a.all_points_y.slice(0),x=_via_region_edge[1]-VIA_POLYGON_RESIZE_VERTEX_OFFSET;h[x]=_via_current_x,j[x]=_via_current_y,_via_draw_polygon_region(h,j,!0,a.name),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", Vertices:"+a.all_points_x.length)}_via_reg_canvas.focus()}if(_via_is_user_moving_region){_via_canvas_regions.length?_via_redraw_reg_canvas():_via_reg_ctx.clearRect(0,0,_via_reg_canvas.width,_via_reg_canvas.height);var k=_via_current_x-_via_region_click_x,l=_via_current_y-_via_region_click_y,a=_via_canvas_regions[_via_user_sel_region_id].shape_attributes;switch(a.name){case VIA_REGION_SHAPE.RECT:_via_draw_rect_region(a.x+k,a.y+l,a.width,a.height,!0),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", W:"+a.width+", H:"+a.height);break;case VIA_REGION_SHAPE.CIRCLE:_via_draw_circle_region(a.cx+k,a.cy+l,a.r,!0);break;case VIA_REGION_SHAPE.ELLIPSE:void 0===a.theta&&(a.theta=0),_via_draw_ellipse_region(a.cx+k,a.cy+l,a.rx,a.ry,a.theta,!0);break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:for(var h=a.all_points_x.slice(0),j=a.all_points_y.slice(0),p=0;p<h.length;++p)h[p]+=k,j[p]+=l;_via_draw_polygon_region(h,j,!0,a.name),null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", Vertices:"+a.all_points_x.length);break;case VIA_REGION_SHAPE.POINT:_via_draw_point_region(a.cx+k,a.cy+l,!0)}_via_reg_canvas.focus();return}if(_via_is_user_drawing_polygon){_via_redraw_reg_canvas();var a=_via_canvas_regions[_via_current_polygon_region_id].shape_attributes,y=a.all_points_x,E=a.all_points_y,q=y.length;if(q>0){var F=[y.slice(q-1),_via_current_x],G=[E.slice(q-1),_via_current_y];_via_draw_polygon_region(F,G,!1,a.name)}null!=b&&_via_is_region_info_visible&&(b.innerHTML+=", Vertices:"+q)}}}function _via_move_selected_regions(c,d){var a,b;for(a=0,b=_via_region_selected_flag.length;a<b;++a)_via_region_selected_flag[a]&&_via_move_region(a,c,d)}function _via_validate_move_region(a,b,c){switch(c.name){case VIA_REGION_SHAPE.RECT:if(a<0||b<0||b+c.height>_via_current_image_height||a+c.width>_via_current_image_width)return show_message("Region moved beyond image boundary. Resetting."),!1;case VIA_REGION_SHAPE.CIRCLE:case VIA_REGION_SHAPE.ELLIPSE:case VIA_REGION_SHAPE.POINT:case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:if(a<0||b<0||a>_via_current_image_width||b>_via_current_image_height)return show_message("Region moved beyond image boundary. Resetting."),!1}return!0}function _via_move_region(i,f,g){var b=_ra_regions[i].shape_attributes,d=_via_canvas_regions[i].shape_attributes;switch(d.name){case VIA_REGION_SHAPE.RECT:var j=b.x+Math.round(f*_via_canvas_scale),k=b.y+Math.round(g*_via_canvas_scale),h=_via_validate_move_region(j,k,b);if(!h)break;b.x=j,b.y=k,d.x=Math.round(b.x/_via_canvas_scale),d.y=Math.round(b.y/_via_canvas_scale);break;case VIA_REGION_SHAPE.CIRCLE:case VIA_REGION_SHAPE.ELLIPSE:case VIA_REGION_SHAPE.POINT:var l=b.cx+Math.round(f*_via_canvas_scale),m=b.cy+Math.round(g*_via_canvas_scale),h=_via_validate_move_region(l,m,b);if(!h)break;b.cx=l,b.cy=m,d.cx=Math.round(b.cx/_via_canvas_scale),d.cy=Math.round(b.cy/_via_canvas_scale);break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:for(var c=b.all_points_x,e=b.all_points_y,n=d.all_points_x,o=d.all_points_y,p=Object.assign({},c),q=Object.assign({},e),a=0;a<c.length;++a){var r=c[a]+Math.round(f*_via_canvas_scale),s=e[a]+Math.round(g*_via_canvas_scale);if(!_via_validate_move_region(r,s,b)){c=p,e=q;break}}for(var a=0;a<c.length;++a)c[a]=c[a]+Math.round(f*_via_canvas_scale),e[a]=e[a]+Math.round(g*_via_canvas_scale);for(var a=0;a<n.length;++a)n[a]=Math.round(c[a]/_via_canvas_scale),o[a]=Math.round(e[a]/_via_canvas_scale)}}function _via_polygon_del_vertex(a,b){var d=_via_canvas_regions[a].shape_attributes,e=d.all_points_x.length,c=d.name;return c!==VIA_REGION_SHAPE.POLYGON&&c!==VIA_REGION_SHAPE.POLYLINE?(show_message("Vertices can only be deleted from polygon/polyline."),!1):e<=3&&c===VIA_REGION_SHAPE.POLYGON?(show_message("Failed to delete vertex because a polygon must have at least 3 vertices."),!1):e<=2&&c===VIA_REGION_SHAPE.POLYLINE?(show_message("Failed to delete vertex because a polyline must have at least 2 vertices."),!1):(_via_canvas_regions[a].shape_attributes.all_points_x.splice(b,1),_via_canvas_regions[a].shape_attributes.all_points_y.splice(b,1),_ra_regions[a].shape_attributes.all_points_x.splice(b,1),_ra_regions[a].shape_attributes.all_points_y.splice(b,1),!0)}function _via_redraw_reg_canvas(){_via_reg_ctx.clearRect(0,0,_via_reg_canvas.width,_via_reg_canvas.height),_via_canvas_regions.length>0&&(_via_is_region_boundary_visible&&draw_all_regions(),_via_is_region_id_visible&&draw_all_region_id())}function _via_clear_reg_canvas(){_via_reg_ctx.clearRect(0,0,_via_reg_canvas.width,_via_reg_canvas.height)}function draw_all_regions(){for(var a,b,d,e=_via_settings.ui.image.region_color,c=0;c<_via_canvas_regions.length;++c)switch(a=_via_canvas_regions[c].shape_attributes,b=_via_region_selected_flag[c],_via_reg_ctx.strokeStyle=VIA_THEME_BOUNDARY_FILL_COLOR,!_via_is_user_drawing_polygon&&"__via_default_region_color__"!==e&&(d=_ra_regions[c].region_attributes[e],_via_canvas_regions_group_color.hasOwnProperty(d)&&(_via_reg_ctx.strokeStyle=_via_canvas_regions_group_color[d])),a.name){case VIA_REGION_SHAPE.RECT:_via_draw_rect_region(a.x,a.y,a.width,a.height,b);break;case VIA_REGION_SHAPE.CIRCLE:_via_draw_circle_region(a.cx,a.cy,a.r,b);break;case VIA_REGION_SHAPE.ELLIPSE:void 0===a.theta&&(a.theta=0),_via_draw_ellipse_region(a.cx,a.cy,a.rx,a.ry,a.theta,b);break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:_via_draw_polygon_region(a.all_points_x,a.all_points_y,b,a.name);break;case VIA_REGION_SHAPE.POINT:_via_draw_point_region(a.cx,a.cy,b)}}function _via_draw_control_point(a,b){_via_reg_ctx.beginPath(),_via_reg_ctx.arc(a,b,VIA_REGION_SHAPES_POINTS_RADIUS,0,2*Math.PI,!1),_via_reg_ctx.closePath(),_via_reg_ctx.fillStyle=VIA_THEME_CONTROL_POINT_COLOR,_via_reg_ctx.globalAlpha=1,_via_reg_ctx.fill()}function _via_draw_rect_region(a,b,c,d,e){e?(_via_draw_rect(a,b,c,d),_via_reg_ctx.strokeStyle=VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_reg_ctx.stroke(),_via_reg_ctx.fillStyle=VIA_THEME_SEL_REGION_FILL_COLOR,_via_reg_ctx.globalAlpha=VIA_THEME_SEL_REGION_OPACITY,_via_reg_ctx.fill(),_via_reg_ctx.globalAlpha=1,_via_draw_control_point(a,b),_via_draw_control_point(a+c,b+d),_via_draw_control_point(a,b+d),_via_draw_control_point(a+c,b),_via_draw_control_point(a+c/2,b),_via_draw_control_point(a+c/2,b+d),_via_draw_control_point(a,b+d/2),_via_draw_control_point(a+c,b+d/2)):(_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_draw_rect(a,b,c,d),_via_reg_ctx.stroke(),c>VIA_THEME_REGION_BOUNDARY_WIDTH&&d>VIA_THEME_REGION_BOUNDARY_WIDTH&&(_via_reg_ctx.strokeStyle=VIA_THEME_BOUNDARY_LINE_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/4,_via_draw_rect(a-VIA_THEME_REGION_BOUNDARY_WIDTH/2,b-VIA_THEME_REGION_BOUNDARY_WIDTH/2,c+VIA_THEME_REGION_BOUNDARY_WIDTH,d+VIA_THEME_REGION_BOUNDARY_WIDTH),_via_reg_ctx.stroke(),_via_draw_rect(a+VIA_THEME_REGION_BOUNDARY_WIDTH/2,b+VIA_THEME_REGION_BOUNDARY_WIDTH/2,c-VIA_THEME_REGION_BOUNDARY_WIDTH,d-VIA_THEME_REGION_BOUNDARY_WIDTH),_via_reg_ctx.stroke()))}function _via_draw_rect(a,b,c,d){_via_reg_ctx.beginPath(),_via_reg_ctx.moveTo(a,b),_via_reg_ctx.lineTo(a+c,b),_via_reg_ctx.lineTo(a+c,b+d),_via_reg_ctx.lineTo(a,b+d),_via_reg_ctx.closePath()}function _via_draw_circle_region(b,c,a,d){d?(_via_draw_circle(b,c,a),_via_reg_ctx.strokeStyle=VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_reg_ctx.stroke(),_via_reg_ctx.fillStyle=VIA_THEME_SEL_REGION_FILL_COLOR,_via_reg_ctx.globalAlpha=VIA_THEME_SEL_REGION_OPACITY,_via_reg_ctx.fill(),_via_reg_ctx.globalAlpha=1,_via_draw_control_point(b+a,c)):(_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_draw_circle(b,c,a),_via_reg_ctx.stroke(),a>VIA_THEME_REGION_BOUNDARY_WIDTH&&(_via_reg_ctx.strokeStyle=VIA_THEME_BOUNDARY_LINE_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/4,_via_draw_circle(b,c,a-VIA_THEME_REGION_BOUNDARY_WIDTH/2),_via_reg_ctx.stroke(),_via_draw_circle(b,c,a+VIA_THEME_REGION_BOUNDARY_WIDTH/2),_via_reg_ctx.stroke()))}function _via_draw_circle(a,b,c){_via_reg_ctx.beginPath(),_via_reg_ctx.arc(a,b,c,0,2*Math.PI,!1),_via_reg_ctx.closePath()}function _via_draw_ellipse_region(d,e,b,c,a,f){f?(_via_draw_ellipse(d,e,b,c,a),_via_reg_ctx.strokeStyle=VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_reg_ctx.stroke(),_via_reg_ctx.fillStyle=VIA_THEME_SEL_REGION_FILL_COLOR,_via_reg_ctx.globalAlpha=VIA_THEME_SEL_REGION_OPACITY,_via_reg_ctx.fill(),_via_reg_ctx.globalAlpha=1,_via_draw_control_point(d+b*Math.cos(a),e+b*Math.sin(a)),_via_draw_control_point(d-b*Math.cos(a),e-b*Math.sin(a)),_via_draw_control_point(d+c*Math.sin(a),e-c*Math.cos(a)),_via_draw_control_point(d-c*Math.sin(a),e+c*Math.cos(a))):(_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_draw_ellipse(d,e,b,c,a),_via_reg_ctx.stroke(),b>VIA_THEME_REGION_BOUNDARY_WIDTH&&c>VIA_THEME_REGION_BOUNDARY_WIDTH&&(_via_reg_ctx.strokeStyle=VIA_THEME_BOUNDARY_LINE_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/4,_via_draw_ellipse(d,e,b+VIA_THEME_REGION_BOUNDARY_WIDTH/2,c+VIA_THEME_REGION_BOUNDARY_WIDTH/2,a),_via_reg_ctx.stroke(),_via_draw_ellipse(d,e,b-VIA_THEME_REGION_BOUNDARY_WIDTH/2,c-VIA_THEME_REGION_BOUNDARY_WIDTH/2,a),_via_reg_ctx.stroke()))}function _via_draw_ellipse(a,b,c,d,e){_via_reg_ctx.save(),_via_reg_ctx.beginPath(),_via_reg_ctx.ellipse(a,b,c,d,e,0,2*Math.PI),_via_reg_ctx.restore(),_via_reg_ctx.closePath()}function _via_draw_polygon_region(b,c,e,d){if(e){_via_reg_ctx.strokeStyle=VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_reg_ctx.beginPath(),_via_reg_ctx.moveTo(b[0],c[0]);for(var a=1;a<b.length;++a)_via_reg_ctx.lineTo(b[a],c[a]);d===VIA_REGION_SHAPE.POLYGON&&_via_reg_ctx.lineTo(b[0],c[0]),_via_reg_ctx.stroke(),_via_reg_ctx.fillStyle=VIA_THEME_SEL_REGION_FILL_COLOR,_via_reg_ctx.globalAlpha=VIA_THEME_SEL_REGION_OPACITY,_via_reg_ctx.fill(),_via_reg_ctx.globalAlpha=1;for(var a=0;a<b.length;++a)_via_draw_control_point(b[a],c[a])}else{_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_reg_ctx.beginPath(),_via_reg_ctx.moveTo(b[0],c[0]);for(var a=0;a<b.length;++a)_via_reg_ctx.lineTo(b[a],c[a]);d===VIA_REGION_SHAPE.POLYGON&&_via_reg_ctx.lineTo(b[0],c[0]),_via_reg_ctx.stroke()}}function _via_draw_point_region(a,b,c){c?(_via_draw_point(a,b,VIA_REGION_POINT_RADIUS),_via_reg_ctx.strokeStyle=VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_reg_ctx.stroke(),_via_reg_ctx.fillStyle=VIA_THEME_SEL_REGION_FILL_COLOR,_via_reg_ctx.globalAlpha=VIA_THEME_SEL_REGION_OPACITY,_via_reg_ctx.fill(),_via_reg_ctx.globalAlpha=1):(_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/2,_via_draw_point(a,b,VIA_REGION_POINT_RADIUS),_via_reg_ctx.stroke(),_via_reg_ctx.strokeStyle=VIA_THEME_BOUNDARY_LINE_COLOR,_via_reg_ctx.lineWidth=VIA_THEME_REGION_BOUNDARY_WIDTH/4,_via_draw_point(a,b,VIA_REGION_POINT_RADIUS-VIA_THEME_REGION_BOUNDARY_WIDTH/2),_via_reg_ctx.stroke(),_via_draw_point(a,b,VIA_REGION_POINT_RADIUS+VIA_THEME_REGION_BOUNDARY_WIDTH/2),_via_reg_ctx.stroke())}function _via_draw_point(a,b,c){_via_reg_ctx.beginPath(),_via_reg_ctx.arc(a,b,c,0,2*Math.PI,!1),_via_reg_ctx.closePath()}function draw_all_region_id(){_via_reg_ctx.shadowColor="transparent",_via_reg_ctx.font=_via_settings.ui.image.region_label_font;for(var b=0;b<_ra_regions.length;++b){var c,d=_via_canvas_regions[b],h=get_region_bounding_box(d),i=h[0],e=h[1],j=Math.abs(h[2]-h[0]),f=_via_reg_ctx.measureText("M").width,g=1.8*f,a=(b+1).toString(),k=_ra_regions[b].region_attributes[_via_settings.ui.image.region_label];if(_ra_regions[b].shape_attributes.name,"__via_region_id__"!==_via_settings.ui.image.region_label){if(void 0!==k)switch(typeof k){default:case"string":a=k;break;case"object":a=Object.keys(k).join(",")}else a="undefined"}var l=_via_reg_ctx.measureText(a).width;if(l>j){if("__via_region_id__"===_via_settings.ui.image.region_label)c=l+f;else{var m=Math.floor(j*a.length/l);m>1?(a=a.substr(0,m-1)+".",c=j):(a=a.substr(0,1)+".",c=2*f)}}else c=l+f;d.shape_attributes.name===VIA_REGION_SHAPE.POLYGON||d.shape_attributes.name===VIA_REGION_SHAPE.POLYLINE?(i=d.shape_attributes.all_points_x[0],e=d.shape_attributes.all_points_y[0]):i-=c/2-j/2,e<g&&(e=g),_via_reg_ctx.fillStyle="black",_via_reg_ctx.globalAlpha=.8,_via_reg_ctx.fillRect(Math.floor(i),Math.floor(e-1.1*g),Math.floor(c),Math.floor(g)),_via_reg_ctx.globalAlpha=1,_via_reg_ctx.fillStyle="yellow",_via_reg_ctx.fillText(a,Math.floor(i+.4*f),Math.floor(e-.35*g))}}function get_region_bounding_box(r){var a=r.shape_attributes,b=new Array(4);switch(a.name){case"rect":b[0]=a.x,b[1]=a.y,b[2]=a.x+a.width,b[3]=a.y+a.height;break;case"circle":b[0]=a.cx-a.r,b[1]=a.cy-a.r,b[2]=a.cx+a.r,b[3]=a.cy+a.r;break;case"ellipse":let f=a.theta,k=f+Math.PI/2,l=a.rx*Math.cos(f),m=a.rx*Math.sin(f),n=a.ry*Math.cos(k),o=a.ry*Math.sin(k),p=2*Math.sqrt(l*l+n*n),q=2*Math.sqrt(m*m+o*o);b[0]=a.cx-p/2,b[1]=a.cy-q/2,b[2]=a.cx+p/2,b[3]=a.cy+q/2;break;case"polyline":case"polygon":for(var d=a.all_points_x,e=a.all_points_y,g=Number.MAX_SAFE_INTEGER,h=Number.MAX_SAFE_INTEGER,i=0,j=0,c=0;c<d.length;++c)d[c]<g&&(g=d[c]),d[c]>i&&(i=d[c]),e[c]<h&&(h=e[c]),e[c]>j&&(j=e[c]);b[0]=g,b[1]=h,b[2]=i,b[3]=j;break;case"point":b[0]=a.cx-VIA_REGION_POINT_RADIUS,b[1]=a.cy-VIA_REGION_POINT_RADIUS,b[2]=a.cx+VIA_REGION_POINT_RADIUS,b[3]=a.cy+VIA_REGION_POINT_RADIUS}return b}function is_inside_region(f,g,h){var b,c,d,e=_via_canvas_regions.length;if(0===e)return -1;h?(b=e-1,c=-1,d=-1):(b=0,c=e,d=1);for(var a=b;a!==c;){if(is_inside_this_region(f,g,a))return a;a+=d}return -1}function is_inside_this_region(c,d,e){var a=_via_canvas_regions[e].shape_attributes,b=!1;switch(a.name){case VIA_REGION_SHAPE.RECT:b=is_inside_rect(a.x,a.y,a.width,a.height,c,d);break;case VIA_REGION_SHAPE.CIRCLE:b=is_inside_circle(a.cx,a.cy,a.r,c,d);break;case VIA_REGION_SHAPE.ELLIPSE:b=is_inside_ellipse(a.cx,a.cy,a.rx,a.ry,a.theta,c,d);break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:b=is_inside_polygon(a.all_points_x,a.all_points_y,c,d);break;case VIA_REGION_SHAPE.POINT:b=is_inside_point(a.cx,a.cy,c,d)}return b}function is_inside_circle(d,e,a,f,g){var b=f-d,c=g-e;return b*b+c*c<a*a}function is_inside_rect(a,b,e,f,c,d){return c>a&&c<a+e&&d>b&&d<b+f}function is_inside_ellipse(b,c,d,e,a,f,g){var h=Math.cos(-a)*(b-f)-Math.sin(-a)*(c-g),i=Math.sin(-a)*(b-f)+Math.cos(-a)*(c-g);return h*h/(d*d)+i*i/(e*e)<1}function is_inside_polygon(d,a,h,c){if(0===d.length||0===a.length)return 0;var b,e=0,g=d.length;for(b=0;b<g-1;++b){var f=is_left(d[b],a[b],d[b+1],a[b+1],h,c);a[b]<=c?a[b+1]>c&&f>0&& ++e:a[b+1]<=c&&f<0&& --e}var f=is_left(d[g-1],a[g-1],d[0],a[0],h,c);return(a[g-1]<=c?a[0]>c&&f>0&& ++e:a[0]<=c&&f<0&& --e,0===e)?0:1}function is_inside_point(c,d,e,f){var a=e-c,b=f-d;return a*a+b*b<VIA_POLYGON_VERTEX_MATCH_TOL*VIA_POLYGON_VERTEX_MATCH_TOL}function is_left(a,b,c,d,e,f){return(c-a)*(f-b)-(e-a)*(d-b)}function is_on_region_corner(c,d){for(var e=[-1,-1],f=0;f<_via_canvas_regions.length;++f){var a=_via_canvas_regions[f].shape_attributes,b=!1;switch(e[0]=f,a.name){case VIA_REGION_SHAPE.RECT:b=is_on_rect_edge(a.x,a.y,a.width,a.height,c,d);break;case VIA_REGION_SHAPE.CIRCLE:b=is_on_circle_edge(a.cx,a.cy,a.r,c,d);break;case VIA_REGION_SHAPE.ELLIPSE:b=is_on_ellipse_edge(a.cx,a.cy,a.rx,a.ry,a.theta,c,d);break;case VIA_REGION_SHAPE.POLYLINE:case VIA_REGION_SHAPE.POLYGON:0===(b=is_on_polygon_vertex(a.all_points_x,a.all_points_y,c,d))&&(b=is_on_polygon_edge(a.all_points_x,a.all_points_y,c,d));break;case VIA_REGION_SHAPE.POINT:b=0}if(b>0)return e[1]=b,e}return e[0]=-1,e}function is_on_rect_edge(a,b,i,j,c,d){var e=Math.abs(a-c),f=Math.abs(b-d),g=Math.abs(a+i-c),h=Math.abs(b+j-d);if(e<VIA_REGION_EDGE_TOL&&f<VIA_REGION_EDGE_TOL)return 1;if(g<VIA_REGION_EDGE_TOL&&f<VIA_REGION_EDGE_TOL)return 2;if(g<VIA_REGION_EDGE_TOL&&h<VIA_REGION_EDGE_TOL)return 3;if(e<VIA_REGION_EDGE_TOL&&h<VIA_REGION_EDGE_TOL)return 4;var k=Math.abs(a+i/2-c),l=Math.abs(b+j/2-d);return k<VIA_REGION_EDGE_TOL&&f<VIA_REGION_EDGE_TOL?5:g<VIA_REGION_EDGE_TOL&&l<VIA_REGION_EDGE_TOL?6:k<VIA_REGION_EDGE_TOL&&h<VIA_REGION_EDGE_TOL?7:e<VIA_REGION_EDGE_TOL&&l<VIA_REGION_EDGE_TOL?8:0}function is_on_circle_edge(b,c,h,d,e){var f=b-d,g=c-e;if(!(Math.abs(Math.sqrt(f*f+g*g)-h)<VIA_REGION_EDGE_TOL))return 0;var a=Math.atan2(e-c,d-b);return Math.abs(a-Math.PI/2)<VIA_THETA_TOL||Math.abs(a+Math.PI/2)<VIA_THETA_TOL?5:Math.abs(a)<VIA_THETA_TOL||Math.abs(Math.abs(a)-Math.PI)<VIA_THETA_TOL?6:a>0&&a<Math.PI/2?1:a>Math.PI/2&&a<Math.PI?4:a<0&&a> -(Math.PI/2)?2:a< -(Math.PI/2)&&a> -Math.PI?3:void 0}function is_on_ellipse_edge(c,d,i,j,e,a,b){var k=Math.cos(-e)*(a-=c)-Math.sin(-e)*(b-=d),l=Math.sin(-e)*a+Math.cos(-e)*b;a=k+c,b=l+d;var g=(c-a)/i,h=(d-b)/j;if(!(Math.abs(Math.sqrt(g*g+h*h)-1)<VIA_ELLIPSE_EDGE_TOL))return 0;var f=Math.atan2(b-d,a-c);return Math.abs(f-Math.PI/2)<VIA_THETA_TOL||Math.abs(f+Math.PI/2)<VIA_THETA_TOL?5:Math.abs(f)<VIA_THETA_TOL||Math.abs(Math.abs(f)-Math.PI)<VIA_THETA_TOL?6:void 0}function is_on_polygon_vertex(b,d,e,f){var a,c;for(a=0,c=b.length;a<c;++a)if(Math.abs(b[a]-e)<VIA_POLYGON_VERTEX_MATCH_TOL&&Math.abs(d[a]-f)<VIA_POLYGON_VERTEX_MATCH_TOL)return VIA_POLYGON_RESIZE_VERTEX_OFFSET+a;return 0}function is_on_polygon_edge(b,c,f,g){for(a=0,h=b.length,d=[];a<h-1;++a)j=dist_to_line(f,g,b[a],c[a],b[a+1],c[a+1]),d.push(j);j=dist_to_line(f,g,b[h-1],c[h-1],b[0],c[0]),d.push(j);var a,h,j,d,e=d[0],i=0;for(a=1,h=d.length;a<h;++a)d[a]<e&&(e=d[a],i=a);return e<VIA_POLYGON_VERTEX_MATCH_TOL?VIA_POLYGON_RESIZE_VERTEX_OFFSET+i:0}function is_point_inside_bounding_box(f,g,b,c,d,e){var a={};return b<d?(a.x1=b,a.x2=d):(a.x1=d,a.x2=b),c<e?(a.y1=c,a.y2=e):(a.y1=e,a.y2=c),f>=a.x1&&f<=a.x2&&g>=a.y1&&g<=a.y2}function dist_to_line(g,h,a,b,c,d){if(!is_point_inside_bounding_box(g,h,a,b,c,d))return Number.MAX_SAFE_INTEGER;var e=d-b,f=c-a,i=Math.abs(e*g-f*h+c*b-d*a),j=Math.sqrt(f*f+e*e),k=i/j;return Math.round(k)}function rect_standardize_coordinates(a){if(a[0]>a[2]){var b=a[0];a[0]=a[2],a[2]=b}if(a[1]>a[3]){var b=a[1];a[1]=a[3],a[3]=b}}function rect_update_corner(l,a,b,c,m){if(m)switch(l){case 1:case 3:var d=a[2]-a[0],e=a[3]-a[1],f=Math.sqrt(d*d+e*e),g=d/f,h=e/f,i=(b-a[0])*g+(c-a[1])*h,j=g*i,k=h*i;b=Math.round(a[0]+j),c=Math.round(a[1]+k);break;case 2:case 4:var d=a[2]-a[0],e=a[1]-a[3],f=Math.sqrt(d*d+e*e),g=d/f,h=e/f,i=(b-a[0])*g+(c-a[3])*h,j=g*i,k=h*i;b=Math.round(a[0]+j),c=Math.round(a[3]+k)}switch(l){case 1:a[0]=b,a[1]=c;break;case 3:a[2]=b,a[3]=c;break;case 2:a[2]=b,a[1]=c;break;case 4:a[0]=b,a[3]=c;break;case 5:a[1]=c;break;case 6:a[2]=b;break;case 7:a[3]=c;break;case 8:a[0]=b}}function _via_update_ui_components(){switch(show_message("Updating user interface components."),_via_display_area_content_name){case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID:image_grid_set_content_panel_height_fixed(),image_grid_set_content_to_current_group();break;case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE:!_via_is_window_resized&&_via_current_image_loaded&&(_via_is_window_resized=!0,_via_show_img(_via_image_index),_via_is_canvas_zoomed&&reset_zoom_level())}}function _via_window_keydown_handler(a){a.target===document.body&&_via_handle_global_keydown_event(a)}function _via_handle_global_keydown_event(a){if(_via_current_image_loaded){if("+"===a.key)return;if("="===a.key){reset_zoom_level();return}if("-"===a.key)return}if("Escape"===a.key){a.preventDefault(),_via_is_loading_current_image&&_via_cancel_current_image_loading(),_via_is_user_resizing_region&&(_via_is_user_resizing_region=!1),_via_is_region_selected&&(_via_is_region_selected=!1,_via_user_sel_region_id=-1,toggle_all_regions_selection(!1)),_via_is_user_drawing_polygon&&(_via_is_user_drawing_polygon=!1,_via_canvas_regions.splice(_via_current_polygon_region_id,1)),_via_is_user_drawing_region&&(_via_is_user_drawing_region=!1),_via_is_user_resizing_region&&(_via_is_user_resizing_region=!1),_via_is_user_moving_region&&(_via_is_user_moving_region=!1),_via_redraw_reg_canvas();return}}function _via_reg_canvas_keyup_handler(a){"Control"===a.key&&(_via_is_ctrl_pressed=!1)}function _via_reg_canvas_keydown_handler(a){if("Control"===a.key&&(_via_is_ctrl_pressed=!0),_via_current_image_loaded){if("Enter"===a.key&&(_via_current_shape===VIA_REGION_SHAPE.POLYLINE||_via_current_shape===VIA_REGION_SHAPE.POLYGON)&&_via_polyshape_finish_drawing(),"Backspace"===a.key&&(_via_current_shape===VIA_REGION_SHAPE.POLYLINE||_via_current_shape===VIA_REGION_SHAPE.POLYGON)&&_via_polyshape_delete_last_vertex(),"a"===a.key){sel_all_regions(),a.preventDefault();return}if("c"===a.key){(_via_is_region_selected||_via_is_all_region_selected)&&copy_sel_regions(),a.preventDefault();return}if("v"===a.key){paste_sel_regions_in_current_image(),a.preventDefault();return}if("b"===a.key){toggle_region_boundary_visibility(),a.preventDefault();return}if("l"===a.key){toggle_region_id_visibility(),a.preventDefault();return}if("d"===a.key){(_via_is_region_selected||_via_is_all_region_selected)&&del_sel_regions(),a.preventDefault();return}if(_via_is_region_selected&&("ArrowRight"===a.key||"ArrowLeft"===a.key||"ArrowDown"===a.key||"ArrowUp"===a.key)){var b=1;a.shiftKey&&(b=10);var c=0,d=0;switch(a.key){case"ArrowLeft":c=-b;break;case"ArrowUp":d=-b;break;case"ArrowRight":c=b;break;case"ArrowDown":d=b}_via_move_selected_regions(c,d),_via_redraw_reg_canvas(),a.preventDefault();return}}_via_handle_global_keydown_event(a)}function _via_polyshape_finish_drawing(){if(_via_is_user_drawing_polygon){var a=_via_current_polygon_region_id,b=_via_current_shape,c=_via_canvas_regions[a].shape_attributes.all_points_x.length;if(c<=2&&b===VIA_REGION_SHAPE.POLYGON){show_message("For a polygon, you must define at least 3 points. Press [Esc] to cancel drawing operation.!");return}if(c<=1&&b===VIA_REGION_SHAPE.POLYLINE){show_message("A polyline must have at least 2 points. Press [Esc] to cancel drawing operation.!");return}var d=_via_image_id;_via_current_polygon_region_id=-1,_via_is_user_drawing_polygon=!1,_via_is_user_drawing_region=!1,_ra_regions[a]={},_via_polyshape_add_new_polyshape(d,b,a),select_only_region(a),_via_redraw_reg_canvas(),_via_reg_canvas.focus()}}function _via_polyshape_delete_last_vertex(){if(_via_is_user_drawing_polygon){var a=_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_x.length;a>0&&(_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_x.splice(a-1,1),_via_canvas_regions[_via_current_polygon_region_id].shape_attributes.all_points_y.splice(a-1,1),_via_redraw_reg_canvas(),_via_reg_canvas.focus())}}function _via_polyshape_add_new_polyshape(i,f,b){var a,c=_via_canvas_regions[b].shape_attributes.all_points_x.slice(0),d=_via_canvas_regions[b].shape_attributes.all_points_y.slice(0),g=[],h=[],j=c.length;for(a=0;a<j;++a)c[a]=Math.round(c[a]*_via_canvas_scale),d[a]=Math.round(d[a]*_via_canvas_scale),g[a]=Math.round(c[a]/_via_canvas_scale),h[a]=Math.round(d[a]/_via_canvas_scale);var e=new file_region;e.shape_attributes.name=f,e.shape_attributes.all_points_x=c,e.shape_attributes.all_points_y=d,_ra_regions[b]=e,i===_via_image_id&&(_via_canvas_regions[b].shape_attributes.name=f,_via_canvas_regions[b].shape_attributes.all_points_x=g,_via_canvas_regions[b].shape_attributes.all_points_y=h)}function del_sel_regions(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){if(!_via_current_image_loaded){show_message("First load some images!");return}var c=0;if(_via_is_all_region_selected)c=_via_canvas_regions.length,_via_canvas_regions.splice(0),_ra_regions.splice(0);else{for(var b=[],a=0;a<_via_canvas_regions.length;++a)_via_region_selected_flag[a]&&(b.push(a),_via_region_selected_flag[a]=!1);b.sort(function(a,b){return b-a});for(var a=0;a<b.length;++a)_via_canvas_regions.splice(b[a],1),_ra_regions.splice(b[a],1),c+=1;b.length&&(_via_reg_canvas.style.cursor="default")}_via_is_all_region_selected=!1,_via_is_region_selected=!1,_via_user_sel_region_id=-1,0===_via_canvas_regions.length?_via_clear_reg_canvas():_via_redraw_reg_canvas(),_via_reg_canvas.focus(),show_message("Deleted "+c+" selected regions")}}function sel_all_regions(){if(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){image_grid_group_toggle_select_all();return}if(!_via_current_image_loaded){show_message("First load some images!");return}toggle_all_regions_selection(!0),_via_is_all_region_selected=!0,_via_redraw_reg_canvas()}function copy_sel_regions(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){if(!_via_current_image_loaded){show_message("First load some images!");return}if(_via_is_region_selected||_via_is_all_region_selected){_via_copied_image_regions.splice(0);for(var a=0;a<_ra_regions.length;++a){var b=_ra_regions[a];_via_canvas_regions[a],_via_region_selected_flag[a]&&_via_copied_image_regions.push(clone_image_region(b))}show_message("Copied "+_via_copied_image_regions.length+" selected regions. Press Ctrl + v to paste")}else show_message("Select a region first!")}}function paste_sel_regions_in_current_image(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){if(!_via_current_image_loaded){show_message("First load some images!");return}if(_via_copied_image_regions.length){for(var b=0,a=0;a<_via_copied_image_regions.length;++a){var c=get_region_bounding_box(_via_copied_image_regions[a]);if(c[2]<_via_current_image_width&&c[3]<_via_current_image_height){var d=clone_image_region(_via_copied_image_regions[a]);_ra_regions.push(d),b+=1}}_via_load_canvas_regions();var e=_via_copied_image_regions.length-b;show_message("Pasted "+b+" regions. Discarded "+e+" regions exceeding image boundary."),_via_redraw_reg_canvas(),_via_reg_canvas.focus()}else show_message("To paste a region, you first need to select a region and copy it!")}}function paste_to_multiple_images_with_confirm(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){if(0===_via_copied_image_regions.length){show_message("First copy some regions!");return}invoke_with_user_inputs(paste_to_multiple_images_confirmed,{region_count:{type:"text",name:"Number of copied regions",value:_via_copied_image_regions.length,disabled:!0},prev_next_count:{type:"text",name:'Copy to (count format)<br><span style="font-size:0.8rem">For example: to paste copied regions to the <i>previous 2 images</i> and <i>next 3 images</i>, type <strong>2,3</strong> in the textbox and to paste only in <i>next 5 images</i>, type <strong>0,5</strong></span>',placeholder:"2,3",disabled:!1,size:30},img_index_list:{type:"text",name:'Copy to (image index list)<br><span style="font-size:0.8rem">For example: <strong>2-5,7,9</strong> pastes the copied regions to the images with the following id <i>2,3,4,5,7,9</i> and <strong>3,8,141</strong> pastes to the images with id <i>3,8 and 141</i></span>',placeholder:"2-5,7,9",disabled:!1,size:30},regex:{type:"text",name:'Copy to filenames matching a regular expression<br><span style="font-size:0.8rem">For example: <strong>_large</strong> pastes the copied regions to all images whose filename contain the keyword <i>_large</i></span>',placeholder:"regular expression",disabled:!1,size:30},include_region_attributes:{type:"checkbox",name:"Paste also the region annotations",checked:!0}},{title:"Paste Regions to Multiple Images"})}}function paste_to_multiple_images_confirmed(c){_via_paste_to_multiple_images_input=c;var a,b=generate_img_index_list(c),d=0;for(a=0;a<b.length;a++)d+=paste_regions(b[a]);show_message("Pasted ["+d+"] regions in "+b.length+" images"),b.includes(_via_image_index)&&(_via_load_canvas_regions(),_via_redraw_reg_canvas(),_via_reg_canvas.focus()),user_input_default_cancel_handler()}function paste_regions(c){var a,b=0;if(_via_copied_image_regions.length)for(_via_image_id_list[c],a=0;a<_via_copied_image_regions.length;++a){var d=clone_image_region(_via_copied_image_regions[a]);_ra_regions.push(d),b+=1}return b}function del_sel_regions_with_confirm(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){if(0===_via_copied_image_regions.length){show_message("First copy some regions!");return}_via_paste_to_multiple_images_input&&(a=_via_paste_to_multiple_images_input.prev_next_count.value,b=_via_paste_to_multiple_images_input.img_index_list.value,c=_via_paste_to_multiple_images_input.regex.value);var a,b,c,d={region_count:{type:"text",name:"Number of regions selected",value:_via_copied_image_regions.length,disabled:!0},prev_next_count:{type:"text",name:'Delete from (count format)<br><span style="font-size:0.8rem">For example: to delete copied regions from the <i>previous 2 images</i> and <i>next 3 images</i>, type <strong>2,3</strong> in the textbox and to delete regions only in <i>next 5 images</i>, type <strong>0,5</strong></span>',placeholder:"2,3",disabled:!1,size:30,value:a},img_index_list:{type:"text",name:'Delete from (image index list)<br><span style="font-size:0.8rem">For example: <strong>2-5,7,9</strong> deletes the copied regions to the images with the following id <i>2,3,4,5,7,9</i> and <strong>3,8,141</strong> deletes regions from the images with id <i>3,8 and 141</i></span>',placeholder:"2-5,7,9",disabled:!1,size:30,value:b},regex:{type:"text",name:'Delete from filenames matching a regular expression<br><span style="font-size:0.8rem">For example: <strong>_large</strong> deletes the copied regions from all images whose filename contain the keyword <i>_large</i></span>',placeholder:"regular expression",disabled:!1,size:30,value:c}};invoke_with_user_inputs(del_sel_regions_confirmed,d,{title:"Undo Regions Pasted to Multiple Images"})}}function del_sel_regions_confirmed(d){user_input_default_cancel_handler();var a,b=generate_img_index_list(d),c=0;for(a=0;a<b.length;a++)c+=delete_regions(b[a]);show_message("Deleted ["+c+"] regions in "+b.length+" images"),b.includes(_via_image_index)&&(_via_load_canvas_regions(),_via_redraw_reg_canvas(),_via_reg_canvas.focus())}function delete_regions(c){var b=0;if(_via_copied_image_regions.length)for(_via_image_id_list[c],d=0;d<_via_copied_image_regions.length;++d){var d,a,e=JSON.stringify(_via_copied_image_regions[d].shape_attributes);for(a=_ra_regions.length-1;a>=0;--a)if(JSON.stringify(_ra_regions[a].shape_attributes)===e){_ra_regions.splice(a,1),b+=1;break}}return b}function show_first_image(){if(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){_via_image_grid_group_var.length?image_grid_group_prev({value:0}):show_message('First, create groups by selecting items from "Group by" dropdown list');return}_via_img_count>0&&_via_show_img(_via_img_fn_list_img_index_list[0])}function show_last_image(){if(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){_via_image_grid_group_var.length?image_grid_group_prev({value:_via_image_grid_group_var.length-1}):show_message('First, create groups by selecting items from "Group by" dropdown list');return}if(_via_img_count>0){var a=_via_img_fn_list_img_index_list.length-1;_via_show_img(_via_img_fn_list_img_index_list[a])}}function jump_image_block_get_count(){var a=_via_img_fn_list_img_index_list.length;return a<20?2:a<100?10:a<1e3?25:a<5e3?50:a<1e4?100:a<5e4?500:Math.round(a/50)}function jump_to_next_image_block(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){var b=jump_image_block_get_count();if(b>1){var c=_via_image_index;if(_via_img_fn_list_img_index_list.includes(c)){var a=_via_img_fn_list_img_index_list.indexOf(c)+b;a+1>_via_img_fn_list_img_index_list.length&&(a=0),_via_show_img(_via_img_fn_list_img_index_list[a])}}else move_to_next_image()}}function jump_to_prev_image_block(){if(_via_display_area_content_name!==VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){var b=jump_image_block_get_count();if(b>1){var c=_via_image_index;if(_via_img_fn_list_img_index_list.includes(c)){var a=_via_img_fn_list_img_index_list.indexOf(c)-b;a<0&&(a=_via_img_fn_list_img_index_list.length-1),_via_show_img(_via_img_fn_list_img_index_list[a])}}else move_to_prev_image()}}function set_zoom(b){b===VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX?(_via_is_canvas_zoomed=!1,_via_canvas_zoom_level_index=VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX):(_via_is_canvas_zoomed=!0,_via_canvas_zoom_level_index=b);var a=VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index];set_all_canvas_scale(a);var c=_via_current_image.naturalWidth*a/_via_canvas_scale_without_zoom,d=_via_current_image.naturalHeight*a/_via_canvas_scale_without_zoom;set_all_canvas_size(c,d),_via_canvas_scale=_via_canvas_scale_without_zoom/a,_via_canvas_scale=_via_canvas_scale_without_zoom/a,1===a?VIA_REGION_POINT_RADIUS=VIA_REGION_POINT_RADIUS_DEFAULT:a>1&&(VIA_REGION_POINT_RADIUS=VIA_REGION_POINT_RADIUS_DEFAULT*a),_via_load_canvas_regions(),_via_redraw_reg_canvas(),_via_reg_canvas.focus(),update_vertical_space()}function reset_zoom_level(){if(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){image_grid_image_size_reset(),show_message("Zoom reset");return}if(!_via_current_image_loaded){show_message("First load some images!");return}_via_is_canvas_zoomed?(set_zoom(VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX),show_message("Zoom reset")):show_message("Cannot reset zoom because image zoom has not been applied!"),update_vertical_space()}function zoom_in(){if(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){image_grid_image_size_increase(),show_message("Increased size of images shown in image grid");return}if(!_via_current_image_loaded){show_message("First load some images!");return}_via_is_user_drawing_polygon||_via_is_user_drawing_region||(_via_canvas_zoom_level_index===VIA_CANVAS_ZOOM_LEVELS.length-1?show_message("Further zoom-in not possible"):(set_zoom(_via_canvas_zoom_level_index+1),show_message("Zoomed in to level "+VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index]+"X")))}function zoom_out(){if(_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID){image_grid_image_size_decrease(),show_message("Reduced size of images shown in image grid");return}if(!_via_current_image_loaded){show_message("First load some images!");return}_via_is_user_drawing_polygon||_via_is_user_drawing_region||(0===_via_canvas_zoom_level_index?show_message("Further zoom-out not possible"):(set_zoom(_via_canvas_zoom_level_index-1),show_message("Zoomed out to level "+VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index]+"X")))}function toggle_region_boundary_visibility(){_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE&&(_via_is_region_boundary_visible=!_via_is_region_boundary_visible,_via_redraw_reg_canvas(),_via_reg_canvas.focus()),_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID&&(_via_settings.ui.image_grid.show_region_shape?(_via_settings.ui.image_grid.show_region_shape=!1,document.getElementById("image_grid_content_rshape").innerHTML=""):(_via_settings.ui.image_grid.show_region_shape=!0,image_grid_page_show_all_regions()))}function toggle_region_id_visibility(){_via_is_region_id_visible=!_via_is_region_id_visible,_via_redraw_reg_canvas(),_via_reg_canvas.focus()}function toggle_region_info_visibility(){var a=document.getElementById("region_info");a.classList.contains("display_none")?(a.classList.remove("display_none"),_via_is_region_info_visible=!0):(a.classList.add("display_none"),_via_is_region_info_visible=!1)}function _via_reg_canvas_mouse_wheel_listener(a){_via_current_image_loaded&&a.ctrlKey&&(a.deltaY<0?zoom_in():zoom_out(),a.preventDefault())}function region_visualisation_update(b,g,h){var a,c=[g],d=(c=c.concat(Object.keys(_via_attributes.region))).length,e=c.indexOf(_via_settings.ui.image[b]);if(-1!==e){switch((a=e+h)<0&&(a=d+a),a>=d&&(a-=d),b){case"region_label":_via_settings.ui.image.region_label=c[a],_via_redraw_reg_canvas();break;case"region_color":_via_settings.ui.image.region_color=c[a],_via_regions_group_color_init(),_via_redraw_reg_canvas()}var f=b.replace("_"," ");_via_settings.ui.image[b].startsWith("__via")?show_message(f+" cleared"):show_message(f+" set to region attribute ["+_via_settings.ui.image[b]+"]")}}function is_img_fn_list_visible(){return img_fn_list_panel.classList.contains("show")}function img_loading_spinbar(a,b){}function update_img_fn_list(){}function img_fn_list_onregex(){var a,c=document.getElementById("img_fn_list_regex").value;img_fn_list_generate_html(c),img_fn_list.innerHTML=_via_img_fn_list_html.join(""),img_fn_list_scroll_to_current_file();var b=document.getElementById("filelist_preset_filters_list");if(""===c)b.selectedIndex=0;else for(a=0;a<b.options.length;++a)if("regex"===b.options[a].value){b.selectedIndex=a;break}}function img_fn_list_ith_entry_selected(a,b){b?img_fn_list_ith_entry_add_css_class(a,"sel"):img_fn_list_ith_entry_remove_css_class(a,"sel")}function img_fn_list_ith_entry_error(a,b){b?img_fn_list_ith_entry_add_css_class(a,"error"):img_fn_list_ith_entry_remove_css_class(a,"error")}function img_fn_list_ith_entry_add_css_class(c,b){var a=document.getElementById("fl"+c);a&&!a.classList.contains(b)&&a.classList.add(b)}function img_fn_list_ith_entry_remove_css_class(c,b){var a=document.getElementById("fl"+c);a&&a.classList.contains(b)&&a.classList.remove(b)}function img_fn_list_clear_all_style(){}function img_fn_list_clear_css_classname(c){var a,b=document.getElementById("img_fn_list").childNodes[0].childNodes,d=b.length;for(a=0;a<d;++a)b[a].classList.contains(c)&&b[a].classList.remove(c)}function img_fn_list_ith_entry_html(a){var c="",b=_via_image_filename_list[a];return is_url(b)&&(b=b.substr(0,4)+"..."+get_filename_from_url(b)),c+='<li id="fl'+a+'"',_via_display_area_content_name===VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID?_via_image_grid_page_img_index_list.includes(a)&&(c+=' class="sel"'):a===_via_image_index&&(c+=' class="sel"'),c+=' onclick="jump_to_image('+a+')" title="'+_via_image_filename_list[a]+'">['+(a+1)+"] "+decodeURIComponent(b)+"</li>"}function img_fn_list_generate_html(b){_via_img_fn_list_img_index_list=[],(_via_img_fn_list_html=[]).push("<ul>");for(var a=0;a<_via_image_filename_list.length;++a)null!==_via_image_filename_list[a].match(b)&&(_via_img_fn_list_html.push(img_fn_list_ith_entry_html(a)),_via_img_fn_list_img_index_list.push(a));_via_img_fn_list_html.push("</ul>")}function img_fn_list_scroll_to_current_file(){img_fn_list_scroll_to_file(_via_image_index)}function img_fn_list_scroll_to_file(b){if(_via_img_fn_list_img_index_list.includes(b)){var a=document.getElementById("fl"+b),c=img_fn_list.clientHeight-20,d=img_fn_list.scrollTop,e=img_fn_list.scrollTop+c;a.offsetTop>d?a.offsetTop>e&&(img_fn_list.scrollTop=a.offsetTop):img_fn_list.scrollTop=a.offsetTop-c}}function update_vertical_space(){}function project_set_name(a){_via_settings.project.name=a}function project_init_default_project(){_via_settings.hasOwnProperty("project")||(_via_settings.project={}),project_set_name(project_get_default_project_name())}function project_on_name_update(a){project_set_name(a.value)}function project_get_default_project_name(){let a=new Date;return"via_project_"+(a.getDate()+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getMonth()]+a.getFullYear()+"_"+a.getHours()+"h"+a.getMinutes()+"m")}function project_save_with_confirm(){invoke_with_user_inputs(project_save_confirmed,{project_name:{type:"text",name:"Project Name",value:_via_settings.project.name,disabled:!1,size:30},save_annotations:{type:"checkbox",name:"Save region and file annotations (i.e. manual annotations)",checked:!0,disabled:!1},save_attributes:{type:"checkbox",name:"Save region and file attributes.",checked:!0},save_via_settings:{type:"checkbox",name:"Save VIA application settings",checked:!0}},{title:"Save Project"})}function project_save_confirmed(a){a.project_name.value!==_via_settings.project.name&&project_set_name(a.project_name.value);var b={"_via_settings":_via_settings,"_via_img_metadata":_via_img_metadata,"_via_attributes":_via_attributes,"_via_data_format_version":"2.0.10","_via_image_id_list":_via_image_id_list},c=a.project_name.value+".json",d=new Blob([JSON.stringify(b)],{type:"text/json;charset=utf-8"});save_data_to_local_file(d,c),user_input_default_cancel_handler()}function project_open_select_project_file(){invisible_file_input&&(invisible_file_input.accept=".json",invisible_file_input.onchange=project_open,invisible_file_input.removeAttribute("multiple"),invisible_file_input.click())}function project_open(a){load_text_file(a.target.files[0],project_open_parse_json_file)}function project_open_parse_json_file(e){var a=JSON.parse(e);if(a["_via_settings"]&&a["_via_img_metadata"]&&a["_via_attributes"]){for(var b in project_import_settings(a["_via_settings"]),_via_image_id_list=[],_via_image_filename_list=[],_via_img_count=0,_via_img_metadata={},_via_img_fileref={},_via_img_src={},_via_attributes={region:{},file:{}},_via_buffer_remove_all(),_via_img_metadata={},a["_via_img_metadata"])"filename"in a["_via_img_metadata"][b]&&"size"in a["_via_img_metadata"][b]&&"regions"in a["_via_img_metadata"][b]&&"file_attributes"in a["_via_img_metadata"][b]?(a.hasOwnProperty("_via_image_id_list")||(_via_image_id_list.push(b),_via_image_filename_list.push(a["_via_img_metadata"][b].filename)),_via_img_metadata[b]=a["_via_img_metadata"][b],_via_img_count+=1):console.log("discarding malformed entry for "+b+": "+JSON.stringify(a["_via_img_metadata"][b]));if(a.hasOwnProperty("_via_image_id_list"))for(var f in _via_image_id_list=a["_via_image_id_list"],a["_via_image_id_list"]){var b=a["_via_image_id_list"][f];_via_image_filename_list.push(_via_img_metadata[b].filename)}_via_attributes=a["_via_attributes"],project_parse_via_attributes_from_img_metadata();var c=Object.keys(_via_attributes.file),d=Object.keys(_via_attributes.region);d.length?(_via_attribute_being_updated="region",_via_current_attribute_id=d[0]):c.length&&(_via_attribute_being_updated="file",_via_current_attribute_id=c[0]),""!==_via_settings.core.default_filepath&&_via_file_resolve_all_to_default_filepath(),show_message("Imported project ["+_via_settings.project.name+"] with "+_via_img_count+" files."),_via_img_count>0&&(_via_show_img(0),update_img_fn_list(),_via_reload_img_fn_list_table=!0)}else show_message("Cannot import project from a corrupt file!")}function project_parse_via_attributes_from_img_metadata(){var a,b,c,d;for(a in _via_attributes.hasOwnProperty("file")||(_via_attributes.file={}),_via_attributes.hasOwnProperty("region")||(_via_attributes.region={}),_via_img_metadata){for(b in _via_img_metadata[a].file_attributes)_via_attributes.file.hasOwnProperty(b)||(_via_attributes.file[b]={},_via_attributes.file[b].type="text");for(d=0;d<_via_img_metadata[a].regions.length;++d)for(c in _via_img_metadata[a].regions[d].region_attributes)_via_attributes.region.hasOwnProperty(c)||(_via_attributes.region[c]={},_via_attributes.region[c].type="text")}}function project_import_settings(b){var a,c,d;for(a in b)if("object"==typeof b[a])for(c in b[a])if("object"==typeof b[a][c])for(d in b[a][c])_via_settings[a][c][d]=b[a][c][d];else _via_settings[a][c]=b[a][c];else _via_settings[a]=b[a]}function project_file_remove_with_confirm(){var a=_via_image_id_list[_via_image_index],b=_via_img_metadata[a].filename,c=_via_img_metadata[a].regions.length;invoke_with_user_inputs(project_file_remove_confirmed,{img_index:{type:"text",name:"File Id",value:_via_image_index+1,disabled:!0,size:8},filename:{type:"text",name:"Filename",value:b,disabled:!0,size:30},region_count:{type:"text",name:"Number of regions",disabled:!0,value:c,size:8}},{title:"Remove File from Project"})}function _via_region(e,f,c,g,h,i){this.shape=e,this.id=f,this.scale_factor=g,this.offset_x=h,this.offset_y=i,this.recompute_svg=!1,this.attributes={};var a,b=c.length;if(this.dview=new Array(b),this.dimg=new Array(b),0!==b)for(a=0;a<b;a++){this.dimg[a]=c[a];var d=this.offset_x;a%2!=0&&(d=this.offset_y),this.dview[a]=Math.round(this.dimg[a]*this.scale_factor)+d}switch(this.shape){case"rect":_via_region_rect.call(this),this.svg_attributes=["x","y","width","height"];break;case"circle":_via_region_circle.call(this),this.svg_attributes=["cx","cy","r"];break;case"ellipse":_via_region_ellipse.call(this),this.svg_attributes=["cx","cy","rx","ry","transform"];break;case"line":_via_region_line.call(this),this.svg_attributes=["x1","y1","x2","y2"];break;case"polyline":_via_region_polyline.call(this),this.svg_attributes=["points"];break;case"polygon":_via_region_polygon.call(this),this.svg_attributes=["points"];break;case"point":_via_region_point.call(this),this.shape="circle",this.svg_attributes=["cx","cy","r"]}this.initialize()}function _via_region_rect(){this.is_inside=_via_region_rect.prototype.is_inside,this.is_on_edge=_via_region_rect.prototype.is_on_edge,this.move=_via_region_rect.prototype.move,this.resize=_via_region_rect.prototype.resize,this.initialize=_via_region_rect.prototype.initialize,this.dist_to_nearest_edge=_via_region_rect.prototype.dist_to_nearest_edge}function _via_region_circle(){this.is_inside=_via_region_circle.prototype.is_inside,this.is_on_edge=_via_region_circle.prototype.is_on_edge,this.move=_via_region_circle.prototype.move,this.resize=_via_region_circle.prototype.resize,this.initialize=_via_region_circle.prototype.initialize,this.dist_to_nearest_edge=_via_region_circle.prototype.dist_to_nearest_edge}function _via_region_ellipse(){this.is_inside=_via_region_ellipse.prototype.is_inside,this.is_on_edge=_via_region_ellipse.prototype.is_on_edge,this.move=_via_region_ellipse.prototype.move,this.resize=_via_region_ellipse.prototype.resize,this.initialize=_via_region_ellipse.prototype.initialize,this.dist_to_nearest_edge=_via_region_ellipse.prototype.dist_to_nearest_edge}function _via_region_line(){this.is_inside=_via_region_line.prototype.is_inside,this.is_on_edge=_via_region_line.prototype.is_on_edge,this.move=_via_region_line.prototype.move,this.resize=_via_region_line.prototype.resize,this.initialize=_via_region_line.prototype.initialize,this.dist_to_nearest_edge=_via_region_line.prototype.dist_to_nearest_edge}function _via_region_polyline(){this.is_inside=_via_region_polyline.prototype.is_inside,this.is_on_edge=_via_region_polyline.prototype.is_on_edge,this.move=_via_region_polyline.prototype.move,this.resize=_via_region_polyline.prototype.resize,this.initialize=_via_region_polyline.prototype.initialize,this.dist_to_nearest_edge=_via_region_polyline.prototype.dist_to_nearest_edge}function _via_region_polygon(){this.is_inside=_via_region_polygon.prototype.is_inside,this.is_on_edge=_via_region_polygon.prototype.is_on_edge,this.move=_via_region_polygon.prototype.move,this.resize=_via_region_polygon.prototype.resize,this.initialize=_via_region_polygon.prototype.initialize,this.dist_to_nearest_edge=_via_region_polygon.prototype.dist_to_nearest_edge}function _via_region_point(){this.is_inside=_via_region_point.prototype.is_inside,this.is_on_edge=_via_region_point.prototype.is_on_edge,this.move=_via_region_point.prototype.move,this.resize=_via_region_point.prototype.resize,this.initialize=_via_region_point.prototype.initialize,this.dist_to_nearest_edge=_via_region_point.prototype.dist_to_nearest_edge}function _via_buffer_hide_current_image(){_via_clear_reg_canvas()}function _via_show_img_from_buffer(){_via_click_x0=0,_via_click_y0=0,_via_click_x1=0,_via_click_y1=0,_via_is_user_drawing_region=!1,_via_is_window_resized=!1,_via_is_user_resizing_region=!1,_via_is_user_moving_region=!1,_via_is_user_drawing_polygon=!1,_via_is_region_selected=!1,_via_user_sel_region_id=-1,_via_current_image_height=420,set_all_canvas_size(_via_canvas_width=_via_current_image_width=350,_via_canvas_height=_via_current_image_height),toggle_all_regions_selection(!1),_via_load_canvas_regions(),_via_redraw_reg_canvas(),_via_reg_canvas.focus(),_via_is_canvas_zoomed&&set_zoom(_via_canvas_zoom_level_index)}function is_url(a){return!!(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("www."))}function get_filename_from_url(a){return a.substring(a.lastIndexOf("/")+1)}function fixfloat(a){return parseFloat(a.toFixed(VIA_FLOAT_PRECISION))}function shape_attribute_fixfloat(a){for(var b in a)switch(b){case"x":case"y":case"width":case"height":case"r":case"rx":case"ry":a[b]=fixfloat(a[b]);break;case"all_points_x":case"all_points_y":for(var c in a[b])a[b][c]=fixfloat(a[b][c])}}function array_intersect(a){if(0===a.length)return[];if(1===a.length)return a[0];var b,d,c,f=a[0],g=0;for(b=1;b<a.length;++b)a[b].length<f.length&&(f=a[b],g=b);var h=[],e={};for(b=0;b<a.length;++b)for(c=0,d=0===b?g:b;c<a[d].length;++c)e[a[d][c]]===b-1?b===a.length-1?(h.push(a[d][c]),e[a[d][c]]=0):e[a[d][c]]=b:e[a[d][c]]=0;return h}function generate_img_index_list(b){var d=[],g=[];if(""!==b.prev_next_count.value){var h=b.prev_next_count.value.split(",");if(2===h.length){var a,k=parseInt(h[0]),l=parseInt(h[1]);for(a=_via_image_index-k;a<=_via_image_index+l;a++)g.push(a)}}0!==g.length&&d.push(g);var e=[];if(""!==b.img_index_list.value){var c=b.img_index_list.value.split(",");if(0!==c.length)for(a=0;a<c.length;++a)if(c[a].includes("-")){var a,f,j=c[a].split("-"),m=parseInt(j[0])-1,n=parseInt(j[1])-1;for(f=m;f<=n;++f)e.push(f)}else e.push(parseInt(c[a])-1)}0!==e.length&&d.push(e);var i=[];if(""!==b.regex.value)for(var o=b.regex.value,a=0;a<_via_image_filename_list.length;++a)null!==_via_image_filename_list[a].match(o)&&i.push(a);return 0!==i.length&&d.push(i),array_intersect(d)}function polygon_to_bbox(b){for(var c=Infinity,e=-1/0,d=Infinity,f=-1/0,a=0;a<b.length;a+=2)b[a]>e&&(e=b[a]),b[a]<c&&(c=b[a]),b[a+1]>f&&(f=b[a+1]),b[a+1]<d&&(d=b[a+1]);return[c,d,e-c,f-d]}_via_region.prototype.prepare_svg_element=function(){this.svg_element=document.createElementNS("http://www.w3.org/2000/svg",this.shape),this.svg_string="<"+this.shape,this.svg_element.setAttributeNS(null,"id",this.id);for(var b=this.svg_attributes.length,a=0;a<b;a++)this.svg_element.setAttributeNS(null,this.svg_attributes[a],this[this.svg_attributes[a]]),this.svg_string+=" "+this.svg_attributes[a]+'="'+this[this.svg_attributes[a]]+'"';this.svg_string+="/>"},_via_region.prototype.get_svg_element=function(){return this.recompute_svg&&(this.prepare_svg_element(),this.recompute_svg=!1),this.svg_element},_via_region.prototype.get_svg_string=function(){return this.recompute_svg&&(this.prepare_svg_element(),this.recompute_svg=!1),this.svg_string},_via_region_rect.prototype.initialize=function(){this.dview[0]<this.dview[2]?(this.x=this.dview[0],this.x2=this.dview[2]):(this.x=this.dview[2],this.x2=this.dview[0]),this.dview[1]<this.dview[3]?(this.y=this.dview[1],this.y2=this.dview[3]):(this.y=this.dview[3],this.y2=this.dview[1]),this.width=this.x2-this.x,this.height=this.y2-this.y,this.recompute_svg=!0},_via_region_circle.prototype.initialize=function(){this.cx=this.dview[0],this.cy=this.dview[1];var a=this.dview[2]-this.dview[0],b=this.dview[3]-this.dview[1];this.r=Math.round(Math.sqrt(a*a+b*b)),this.r2=this.r*this.r,this.recompute_svg=!0},_via_region_ellipse.prototype.initialize=function(){this.cx=this.dview[0],this.cy=this.dview[1],this.rx=Math.abs(this.dview[2]-this.dview[0]),this.ry=Math.abs(this.dview[3]-this.dview[1]),this.inv_rx2=1/(this.rx*this.rx),this.inv_ry2=1/(this.ry*this.ry),this.recompute_svg=!0},_via_region_line.prototype.initialize=function(){this.x1=this.dview[0],this.y1=this.dview[1],this.x2=this.dview[2],this.y2=this.dview[3],this.dx=this.x1-this.x2,this.dy=this.y1-this.y2,this.mconst=this.x1*this.y2-this.x2*this.y1,this.recompute_svg=!0},_via_region_polyline.prototype.initialize=function(){for(var b=this.dview.length,c=new Array(b/2),d=0,a=0;a<b;a+=2)c[d]=this.dview[a]+" "+this.dview[a+1],d++;this.points=c.join(","),this.recompute_svg=!0},_via_region_polygon.prototype.initialize=function(){for(var b=this.dview.length,c=new Array(b/2),d=0,a=0;a<b;a+=2)c[d]=this.dview[a]+" "+this.dview[a+1],d++;this.points=c.join(","),this.recompute_svg=!0},_via_region_point.prototype.initialize=function(){this.cx=this.dview[0],this.cy=this.dview[1],this.r=2,this.r2=this.r*this.r,this.recompute_svg=!0}