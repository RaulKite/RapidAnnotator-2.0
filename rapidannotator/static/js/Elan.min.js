var Timeline=function(t){this.destroyed=!1,this.zoomOnScroll=!0,this.hideTracksOnSelection=!1,this.videoId=t,this.videoElement=document.getElementById(this.videoId),this.startTime=0,this.endTime=10,this.currentTrackIndex=-1,this.clickedTrackIndex=-1,this.currentAnnotationIndex=-1,this.loadedAnnotationIndex=-1,this.loadedAnnotationTrackIndex=-1,this.tracks=[],this.time=0,this.totalTime=0,this.loopCount=0,this.playing=!1;var e=this;if(!this.videoElement){console.log("DOM does not contain video with this ID");return}this.videoElement.addEventListener("loadedmetadata",function(){e.endTime=e.videoElement.duration}),this.videoElement.addEventListener("ended",function(){this.loopMode?(e.videoElement.currentTime=0,e.play()):(e.playing=!1,e.videoElement.pause())}),this.videoElement.addEventListener("timeupdate",function(){if(e.time=e.videoElement.currentTime,e.totalTime=e.videoElement.duration,e.playing&&e.update(),!e.rangeMode)return;let t=+document.getElementById("af-end-time").value,i=+document.getElementById("af-start-time").value;!(t<=i)&&(e.videoElement.currentTime>t||e.videoElement.currentTime<i)&&(e.videoElement.currentTime=i,e.loopMode?e.loopCount++:e.pause())},!1),this.videoElement.addEventListener("play",function(){e.playing=!0}),this.videoElement.addEventListener("pause",function(){e.playing=!1}),this.videoElement.addEventListener("seeking",function(){e.playing=!1}),this.videoElement.addEventListener("seeked",function(){e.playing=!1}),this.videoElement.addEventListener("waiting",function(){e.playing=!1}),this.videoFrameObject=VideoFrame({id:t}),this.seekMode=0,this.rangeMode=!1,this.loopMode=!1,setInterval(function(){e.update()},1e3/30)};Timeline.prototype.addTrack=function(t,e="track",i=[],s=[],h="#ffffff"){i=i.sort(function(t,e){return t.startTime-e.startTime});let n={id:t,index:this.tracks.length,name:e,color:h,annotations:i};this.tracks.push(n),document.getElementById("af-tracks-select").innerHTML+=`<option value='${n.index}'> ${n.name} </option>`,s.length>0&&this.addTrackDataListOptions(this.tracks.length-1,s)},Timeline.prototype.addTrackDataListOptions=function(t,e){var i=document.createElement("datalist");i.id=`af-labels-${t}`;for(var s=0;s<e.length;s++){var h=document.createElement("option");h.value=e[s].name,h.setAttribute("data-key",e[s].key),h.setAttribute("title",e[s].key),h.setAttribute("data-label-id",e[s].id),i.appendChild(h)}document.body.appendChild(i)},Timeline.prototype.destroy=function(){this.destroyed=!0,this.videoElement=null,this.tracks=[],this.canvas.height=0,this.canvas.width=0,document.getElementById("timeline").style.display="none"},Timeline.prototype.play=function(){var t;this.playing=!0,this.shouldPlay=!1,(t=document.getElementById(this.videoId))&&(t.play(),this.time=t.currentTime)},Timeline.prototype.pause=function(){this.playing=!1,document.getElementById(this.videoId).pause()},Timeline.prototype.stop=function(){this.playing=!1,this.time=0,this.prevTime=this.time-FRAME_DELTA,document.getElementById(this.videoId).pause(),document.getElementById(this.videoId).currentTime=0},Timeline.prototype.changeTrack=function(t){if(null!==t){var e=!1;this.playing&&(this.pause(),e=!0),this.currentTrackIndex=t.index,e&&this.play()}},Timeline.prototype.preUpdate=function(){var t=document.getElementById(this.videoId);t.readyState<t.HAVE_FUTURE_DATA?this.playing&&(this.pause(),this.shouldPlay=!0):this.shouldPlay&&(this.shouldPlay=!1,this.play()),this.updateGUI()},Timeline.prototype.update=function(){!this.destroyed&&(this.preUpdate(),this.playing&&(this.totalTime+=FRAME_DELTA,this.prevTime=this.time,this.time+=FRAME_DELTA))},Timeline.prototype.getAnnotationAt=function(t,e){var i=this.tracksScrollY*(this.tracks.length*this.trackLabelHeight-this.canvas.height+this.headerHeight),s=Math.floor((e-this.headerHeight+i)/this.trackLabelHeight);if(s>=0&&s>=this.tracks.length)return null;this.clickedTrackIndex=s;for(var h=this.xToTime(t),n=-1,a=this.tracks[s].annotations.length-1;a>-1;a--){var o=this.tracks[s].annotations[a];if(o.startTime<=h&&o.endTime>=h){n=a;break}}if(-1==n)return null;if(-1!==n&&-1!==s){var o=this.tracks[s].annotations[n];this.tracks[s].annotations.splice(n,1),this.tracks[s].annotations.push(o),n=this.tracks[s].annotations.length-1}return n},Timeline.prototype.getTrackAt=function(t,e){if(t>this.trackLabelWidth)return null;var i=this.tracksScrollY*(this.tracks.length*this.trackLabelHeight-this.canvas.height+this.headerHeight),s=Math.floor((e-this.headerHeight+i)/this.trackLabelHeight);return s>=0&&s>=this.tracks.length?null:this.tracks[s]},Timeline.prototype.findVideoDuration=function(){return this.videoElement.duration},Timeline.prototype.timeToX=function(t){var e=this.findVideoDuration(),i=this.xToTime(this.canvas.width-this.trackLabelWidth-this.tracksScrollWidth)-this.xToTime(20);return i<e&&(t-=(e-i)*this.timeScrollX),this.trackLabelWidth+t*(this.timeScale*this.canvasHeight)+10},Timeline.prototype.xToTime=function(t){var e,i=Math.max(0,(this.findVideoDuration()-(this.canvas.width-this.trackLabelWidth-this.tracksScrollWidth-20)/(this.timeScale*this.canvasHeight))*this.timeScrollX);return(t-this.trackLabelWidth-10)/(this.timeScale*this.canvasHeight)+i},Timeline.prototype.contextMenuShow=function(t){let e=document.getElementById("timeline-cm");e.style.display="block",e.style.left=Math.min(t.pageX,window.innerWidth-e.offsetWidth)+"px",e.style.top=Math.min(t.pageY,window.innerHeight-e.offsetHeight)+"px",-1!=this.currentAnnotationIndex?document.getElementById("cm-delete").style.display="block":document.getElementById("cm-delete").style.display="none"},Timeline.prototype.contextMenuHide=function(){document.getElementById("timeline-cm").style.display="none"},Timeline.prototype.onContextMenu=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.contextMenuShow(t)},Timeline.prototype.contextMenuEditAnnotation=function(t){annotationFormLoad(this.clickedTrackIndex,this.currentAnnotationIndex),this.contextMenuHide(t)},Timeline.prototype.annotationFormLoad=function(t,e){void 0==t&&(t=-1),void 0==e&&(e=-1),-1!==e&&-1!==t&&this.tracks?.[t]?.annotations?.[e]?(document.getElementById("af-delete").style.display="unset",document.getElementById("af-title").innerHTML="Edit Annotation",document.getElementById("af-tracks-select").value=t,document.getElementById("af-text").value=timeline.tracks[t].annotations[e].text,document.getElementById("af-start-time").value=timeline.tracks[t].annotations[e].startTime,document.getElementById("af-end-time").value=timeline.tracks[t].annotations[e].endTime):(document.getElementById("af-delete").style.display="none",this.annotationFormCancel())},Timeline.prototype.annotationFormSave=function(){let t=document.getElementById("af-tracks-select").value,e=parseFloat(document.getElementById("af-start-time").value),i=parseFloat(document.getElementById("af-end-time").value),s=document.getElementById("af-text").value;if(e>=i){alert("Start time must be before end time");return}if(e<0){alert("Start time must be after 0");return}if(i>this.findVideoDuration()){alert("End time must be before end of video");return}if(-1==t){alert("Please select a track");return}if(0==s.length){alert("Annotation text cannot be empty");return}if(isNaN(e)||isNaN(i)){alert("Invalid time");return}if(-1!==this.clickedTrackIndex&&-1!==this.currentAnnotationIndex){this.tracks[this.clickedTrackIndex].annotations[this.currentAnnotationIndex].text=s,this.tracks[this.clickedTrackIndex].annotations[this.currentAnnotationIndex].startTime=e,this.tracks[this.clickedTrackIndex].annotations[this.currentAnnotationIndex].endTime=i;let h=this.tracks[this.clickedTrackIndex].annotations[this.currentAnnotationIndex];this.tracks[this.clickedTrackIndex].annotations.splice(this.currentAnnotationIndex,1),this.tracks[t].annotations.push(h)}else this.tracks[t].annotations.push({text:s,startTime:e,endTime:i});this.annotationFormCancel()},Timeline.prototype.annotationFormDelete=function(){-1!==this.clickedTrackIndex&&-1!==this.currentAnnotationIndex&&this.tracks[this.clickedTrackIndex].annotations.splice(this.currentAnnotationIndex,1),this.annotationFormCancel()},Timeline.prototype.annotationFormCancel=function(t){this.clickedTrackIndex=-1,this.currentAnnotationIndex=-1,this.loadedAnnotationIndex=-1,this.loadedAnnotationTrackIndex=-1,this.contextMenuHide(t),document.getElementById("af-delete").style.display="none",document.getElementById("af-title").innerHTML="Add Annotation",document.getElementById("af-tracks-select").value=-1,document.getElementById("af-text").value="",document.getElementById("af-start-time").value=0,document.getElementById("af-end-time").value=0},Timeline.prototype.contextMenuDeleteAnnotation=function(t){this.contextMenuHide(),-1!=this.currentAnnotationIndex&&-1!=this.clickedTrackIndex&&(this.tracks[this.clickedTrackIndex].annotations.splice(this.currentAnnotationIndex,1),this.currentAnnotationIndex=-1,this.update()),this.annotationFormCancel()},Timeline.prototype.contextMenuZoomin=function(){this.contextMenuHide(),this.timeScale=Math.min(1,this.timeScale+.05),this.update()},Timeline.prototype.contextMenuZoomout=function(){this.contextMenuHide(),this.timeScale=Math.max(.01,this.timeScale-.05),this.update()},Timeline.prototype.contextMenuToggleMouseWheelMode=function(){this.contextMenuHide(),this.zoomOnScroll=!this.zoomOnScroll,this.zoomOnScroll?(document.getElementById("cm-mode").innerHTML="Scroll on mousewheel",this.canvas.removeEventListener("mousewheel",this.defaultOnMouseWheelListener),this.canvas.addEventListener("mousewheel",this.zoomOnMouseWheelListener)):(document.getElementById("cm-mode").innerHTML="Zoom on mousewheel",this.canvas.removeEventListener("mousewheel",this.zoomOnMouseWheelListener),this.canvas.addEventListener("mousewheel",this.defaultOnMouseWheelListener))},Timeline.prototype.contextMenuToggleSelectionMode=function(){this.contextMenuHide(),this.hideTracksOnSelection=!this.hideTracksOnSelection,this.hideTracksOnSelection?document.getElementById("cm-selection").innerHTML="Show all annotations":document.getElementById("cm-selection").innerHTML="Hide annotations on selection"},Timeline.prototype.initGUI=function(){var t=this;this.trackLabelWidth=108,this.trackLabelHeight=20,this.tracksScrollWidth=16,this.tracksScrollHeight=0,this.tracksScrollThumbPos=0,this.tracksScrollThumbHeight=0,this.tracksScrollY=0,this.timeScrollWidth=0,this.timeScrollHeight=16,this.timeScrollThumbPos=0,this.timeScrollThumbWidth=0,this.timeScrollX=0,this.headerHeight=30,this.canvasHeight=200,this.draggingTime=!1,this.draggingTracksScrollThumb=!1,this.draggingTimeScrollThumb=!1,this.draggingKeys=!1,this.draggingTimeScale=!1,this.selectedKeys=[],this.timeScale=.08,this.container=document.createElement("div"),this.container.id="timeline",this.container.style.display="block",this.container.style.width="100%",this.container.style.height=this.canvasHeight+"px",this.container.style.background="#EEEEEE",this.container.style.position="fixed",this.container.style.left="0px",this.container.style.bottom="0px",document.body.appendChild(this.container),this.splitter=document.createElement("div"),this.splitter.style.width="100%",this.splitter.style.height="4px",this.splitter.style.cursor="ns-resize",this.splitter.style.position="fixed",this.splitter.style.left="0px",this.splitter.style.bottom=this.canvasHeight-2+"px",this.splitter.addEventListener("mousedown",function(){function e(e){var i=window.innerHeight-e.clientY;t.splitter.style.bottom=i-2+"px",t.container.style.height=i+"px",t.canvasHeight=i,t.tracksScrollY=0,t.tracksScrollThumbPos=0}function i(t){document.body.removeEventListener("mousemove",e,!1),document.body.removeEventListener("mouseup",i,!1)}document.body.addEventListener("mousemove",e,!1),document.body.addEventListener("mouseup",i,!1)},!1),document.body.appendChild(this.splitter),this.canvas=document.createElement("canvas"),this.c=this.canvas.getContext("2d"),this.canvas.width=0,this.container.appendChild(this.canvas);var t=this;this.zoomOnMouseWheelListener=function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.wheelDelta>=0?t.contextMenuZoomout(e):t.contextMenuZoomin(e)},this.defaultOnMouseWheelListener=function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.wheelDelta>=0?t.scrollUp(e):t.scrollDown(e)},this.canvas.addEventListener("mousedown",function(e){t.onMouseDown(e)},!1),this.canvas.addEventListener("mousewheel",this.zoomOnMouseWheelListener,!1),this.canvas.addEventListener("mousemove",function(e){t.onCanvasMouseMove(e)},!1),this.canvas.addEventListener("contextmenu",function(e){t.onContextMenu(e)},!1),this.canvas.addEventListener("click",function(e){t.onMouseClick(e)},!1),this.canvas.addEventListener("dblclick",function(e){t.onDoubleMouseClick(e)},!1),document.body.addEventListener("click",function(e){t.contextMenuHide()},!1),document.body.addEventListener("mousemove",function(e){t.onDocumentMouseMove(e)},!1),document.getElementById("cm-mode").addEventListener("click",function(e){t.contextMenuToggleMouseWheelMode(e)},!1),document.getElementById("cm-selection").addEventListener("click",function(e){t.contextMenuToggleSelectionMode(e)},!1),document.getElementById("cm-delete").addEventListener("click",function(e){t.contextMenuDeleteAnnotation(e)},!1),document.getElementById("cm-zoomin").addEventListener("click",function(e){t.contextMenuZoomin(e)},!1),document.getElementById("cm-zoomout").addEventListener("click",function(e){t.contextMenuZoomout(e)},!1),document.getElementById("af-cancel").addEventListener("click",function(e){t.annotationFormCancel(e)},!1),document.getElementById("af-delete").addEventListener("click",function(e){t.annotationFormDelete(e)},!1),document.getElementById("af-save").addEventListener("click",function(e){t.annotationFormSave(e)},!1),document.getElementById("af-link-start").addEventListener("click",function(e){t.pause(),document.getElementById("af-start-time").value=+t.videoElement.currentTime},!1),document.getElementById("af-link-end").addEventListener("click",function(e){t.pause(),document.getElementById("af-end-time").value=+t.videoElement.currentTime},!1),document.getElementById("forward-btn").addEventListener("click",function(){t.pause();let e=+document.getElementById("step-size").value;t.seekMode==SEEK_MODE_FRAMES?t.videoFrameObject.seekForward(e):document.getElementById("video").currentTime+=e}),document.getElementById("backward-btn").addEventListener("click",function(){t.pause();let e=+document.getElementById("step-size").value;t.seekMode==SEEK_MODE_FRAMES?t.videoFrameObject.seekBackward(e):document.getElementById("video").currentTime-=e}),document.getElementById("seek-mode-btn").addEventListener("click",function(){t.seekMode==SEEK_MODE_FRAMES?(t.seekMode=SEEK_MODE_SECONDS,document.getElementById("seek-mode-btn").innerHTML="Seconds"):(t.seekMode=SEEK_MODE_FRAMES,document.getElementById("seek-mode-btn").innerHTML="Frames")}),document.getElementById("play-mode-btn").addEventListener("click",function(){t.rangeMode?(t.rangeMode=!1,document.getElementById("play-mode-btn").innerHTML="All"):(t.rangeMode=!0,document.getElementById("play-mode-btn").innerHTML="Selected")}),document.getElementById("loop-mode-btn").addEventListener("click",function(){t.loopMode?(t.loopMode=!1,document.getElementById("loop-mode-btn").innerHTML="Off"):(t.loopMode=!0,document.getElementById("loop-mode-btn").innerHTML="On")}),document.getElementById("af-tracks-select").addEventListener("change",function(){var t=document.getElementById("af-tracks-select").value;-1!==t?document.getElementById("af-text").setAttribute("list","af-labels-"+t):document.getElementById("af-text").setAttribute("list","")})},Timeline.prototype.resetAnnotations=function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].annotations=[]},Timeline.prototype.updateGUI=function(){this.canvas||this.initGUI(),this.canvas.width=window.innerWidth,this.canvas.height=this.canvasHeight;var t=this.canvas.width,e=this.canvas.height;this.tracksScrollHeight=this.canvas.height-this.headerHeight-this.timeScrollHeight;var i=this.tracks.length*this.trackLabelHeight,s=this.tracksScrollHeight/i;this.tracksScrollThumbHeight=Math.min(Math.max(20,this.tracksScrollHeight*s),this.tracksScrollHeight),this.timeScrollWidth=this.canvas.width-this.trackLabelWidth-this.tracksScrollWidth;var h=this.findVideoDuration(),n=this.xToTime(this.canvas.width-this.trackLabelWidth-this.tracksScrollWidth)-this.xToTime(0);this.timeScrollThumbWidth=Math.max(0,Math.min(n/h,1))*this.timeScrollWidth,this.timeScrollThumbPos+this.timeScrollThumbWidth>this.timeScrollWidth&&(this.timeScrollThumbPos=Math.max(0,this.timeScrollWidth-this.timeScrollThumbWidth)),this.c.clearRect(0,0,t,e),this.drawRect(0,0,this.trackLabelWidth,e,"#EEEEEE");for(var a=0;a<this.tracks.length;a++){var o=this.headerHeight+this.trackLabelHeight*(a+1);(o-=this.tracksScrollY*((this.tracks.length+1)*this.trackLabelHeight-this.canvas.height+this.headerHeight))<this.headerHeight||this.drawTrack(this.tracks[a],o,a+1)}var l=0;this.endTime=this.findVideoDuration();var r=this.endTime,c=0;this.drawRect(0,0,this.canvas.width,this.headerHeight,"#EEEEEE"),this.c.fillStyle="#666666";for(var d=this.timeToX(0),m=l;m<r;m++){d=this.timeToX(m),this.drawLine(d,0,d,.3*this.headerHeight,"#999999");var g=Math.floor(m/60),u=m%60,T=g+":"+(u<10?"0":"")+u;d-c>30&&(this.c.fillText(T,d-6,.8*this.headerHeight),c=d),m+=1}this.timeToX(this.time)>this.trackLabelWidth&&this.drawLine(this.timeToX(this.time),0,this.timeToX(this.time),e,"#FF0000"),this.drawRect(0,e-this.timeScrollHeight,this.canvas.width,e,"#EEEEEE");for(var a=2;a<20;a++){var k=1-a*a/361;this.drawLine(7+k*(this.trackLabelWidth-10),e-this.timeScrollHeight+4,7+k*(this.trackLabelWidth-10),e-3,"#999999")}this.c.fillStyle="#666666",this.c.beginPath(),this.c.moveTo(7+(1-this.timeScale)*(this.trackLabelWidth-10),e-7),this.c.lineTo(11+(1-this.timeScale)*(this.trackLabelWidth-10),e-1),this.c.lineTo(3+(1-this.timeScale)*(this.trackLabelWidth-10),e-1),this.c.fill(),this.drawRect(this.canvas.width-this.tracksScrollWidth,this.headerHeight+1,this.tracksScrollWidth,this.tracksScrollHeight,"#DDDDDD"),this.tracksScrollThumbHeight<this.tracksScrollHeight&&this.drawRect(this.canvas.width-this.tracksScrollWidth,this.headerHeight+1+this.tracksScrollThumbPos,this.tracksScrollWidth,this.tracksScrollThumbHeight,"#999999"),this.drawRect(this.trackLabelWidth,e-this.timeScrollHeight,t-this.trackLabelWidth-this.tracksScrollWidth,this.timeScrollHeight,"#DDDDDD"),this.timeScrollThumbWidth<this.timeScrollWidth&&this.drawRect(this.trackLabelWidth+1+this.timeScrollThumbPos,e-this.timeScrollHeight,this.timeScrollThumbWidth,this.timeScrollHeight,"#999999"),this.drawLine(0,0,t,0,"#000000"),this.drawLine(0,this.headerHeight,t,this.headerHeight,"#000000"),this.drawLine(0,e-this.timeScrollHeight,this.trackLabelWidth,e-this.timeScrollHeight,"#000000"),this.drawLine(this.trackLabelWidth,e-this.timeScrollHeight-1,this.trackLabelWidth,e,"#000000"),this.drawRect(0*this.headerHeight- -4,5,this.headerHeight-8,this.headerHeight-8,"#DDDDDD"),this.drawRect(1*this.headerHeight-0,5,this.headerHeight-8,this.headerHeight-8,"#DDDDDD"),this.drawRect(2*this.headerHeight-4,5,this.headerHeight-8,this.headerHeight-8,"#DDDDDD"),this.drawRect(3*this.headerHeight-8,5,this.headerHeight-8,this.headerHeight-8,"#DDDDDD"),this.c.strokeStyle=(this.playing,"#000000"),this.c.beginPath(),this.c.moveTo(10.5,10),this.c.lineTo(this.headerHeight-8,this.headerHeight/2+1.5),this.c.lineTo(10.5,this.headerHeight-8),this.c.lineTo(10.5,10),this.c.stroke(),this.c.strokeStyle="#000000",this.c.strokeRect(this.headerHeight+5.5,10.5,this.headerHeight/6,this.headerHeight-8-11),this.c.strokeRect(this.headerHeight+5.5+this.headerHeight/6+2,10.5,this.headerHeight/6,this.headerHeight-8-11),this.c.strokeRect(2*this.headerHeight-4+5.5,10.5,this.headerHeight-8-11,this.headerHeight-8-11),this.c.beginPath(),this.c.moveTo(3*this.headerHeight-8+5.5,this.headerHeight-9.5),this.c.lineTo(3*this.headerHeight-8+11.5,this.headerHeight-9.5),this.c.moveTo(3*this.headerHeight-8+5.5,this.headerHeight-13.5),this.c.lineTo(3*this.headerHeight-8+13.5,this.headerHeight-13.5),this.c.moveTo(3*this.headerHeight-8+5.5,this.headerHeight-17.5),this.c.lineTo(3*this.headerHeight-8+15.5,this.headerHeight-17.5),this.c.stroke(),this.c.save(),this.c.beginPath(),this.c.moveTo(0,this.headerHeight+1),this.c.lineTo(this.canvas.width,this.headerHeight+1),this.c.lineTo(this.canvas.width,this.canvas.height-this.timeScrollHeight),this.c.lineTo(0,this.canvas.height-this.timeScrollHeight),this.c.clip(),this.c.restore(),this.drawLine(this.trackLabelWidth,0,this.trackLabelWidth,e,"#000000")},Timeline.prototype.scrollUp=function(t){this.tracksScrollThumbPos-=.1*this.tracksScrollHeight,this.tracksScrollThumbPos<0&&(this.tracksScrollThumbPos=0),this.tracksScrollThumbPos=Math.round(this.tracksScrollThumbPos),this.tracksScrollHeight-this.tracksScrollThumbHeight>0?this.tracksScrollY=this.tracksScrollThumbPos/(this.tracksScrollHeight-this.tracksScrollThumbHeight):this.tracksScrollY=0,this.update()},Timeline.prototype.scrollDown=function(t){this.tracksScrollThumbPos+=.1*this.tracksScrollHeight,this.tracksScrollThumbPos>this.tracksScrollHeight-this.tracksScrollThumbHeight&&(this.tracksScrollThumbPos=this.tracksScrollHeight-this.tracksScrollThumbHeight),this.tracksScrollThumbPos=Math.round(this.tracksScrollThumbPos),this.tracksScrollHeight-this.tracksScrollThumbHeight>0?this.tracksScrollY=this.tracksScrollThumbPos/(this.tracksScrollHeight-this.tracksScrollThumbHeight):this.tracksScrollY=0,this.update()},Timeline.prototype.onMouseDown=function(t){if(!t.button){this.selectedKeys=[];var e=t.layerX,i=t.layerY;if(e>this.trackLabelWidth&&i<this.headerHeight)this.draggingTime=!0,this.onDocumentMouseMove(t);else if(e>this.canvas.width-this.tracksScrollWidth&&i>this.headerHeight)i>=this.headerHeight+this.tracksScrollThumbPos&&i<=this.headerHeight+this.tracksScrollThumbPos+this.tracksScrollThumbHeight&&(this.tracksScrollThumbDragOffset=i-this.headerHeight-this.tracksScrollThumbPos,this.draggingTracksScrollThumb=!0);else if(i>this.headerHeight&&i<this.canvasHeight-this.timeScrollHeight){var s=this.getTrackAt(t.layerX,t.layerY);this.changeTrack(s);var h=this.getAnnotationAt(t.layerX,t.layerY);null!=h?this.currentAnnotationIndex=h:this.currentAnnotationIndex=-1}else e<this.trackLabelWidth&&i>this.canvasHeight-this.timeScrollHeight?(this.timeScale=Math.max(.01,Math.min((this.trackLabelWidth-e)/this.trackLabelWidth,1)),this.draggingTimeScale=!0):e>this.trackLabelWidth&&i>this.canvasHeight-this.timeScrollHeight&&e>=this.trackLabelWidth+this.timeScrollThumbPos&&e<=this.trackLabelWidth+this.timeScrollThumbPos+this.timeScrollThumbWidth&&(this.timeScrollThumbDragOffset=e-this.trackLabelWidth-this.timeScrollThumbPos,this.draggingTimeScrollThumb=!0)}},Timeline.prototype.onCanvasMouseMove=function(t){var e=t.layerX,i=t.layerY;this.draggingTracksScrollThumb&&(this.tracksScrollThumbPos=i-this.headerHeight-this.tracksScrollThumbDragOffset,this.tracksScrollThumbPos<0&&(this.tracksScrollThumbPos=0),this.tracksScrollThumbPos+this.tracksScrollThumbHeight>this.tracksScrollHeight&&(this.tracksScrollThumbPos=Math.max(0,this.tracksScrollHeight-this.tracksScrollThumbHeight)),this.tracksScrollHeight-this.tracksScrollThumbHeight>0?this.tracksScrollY=this.tracksScrollThumbPos/(this.tracksScrollHeight-this.tracksScrollThumbHeight):this.tracksScrollY=0),this.draggingTimeScrollThumb&&(this.timeScrollThumbPos=e-this.trackLabelWidth-this.timeScrollThumbDragOffset,this.timeScrollThumbPos<0&&(this.timeScrollThumbPos=0),this.timeScrollThumbPos+this.timeScrollThumbWidth>this.timeScrollWidth&&(this.timeScrollThumbPos=Math.max(0,this.timeScrollWidth-this.timeScrollThumbWidth)),this.timeScrollWidth-this.timeScrollThumbWidth>0?this.timeScrollX=this.timeScrollThumbPos/(this.timeScrollWidth-this.timeScrollThumbWidth):this.timeScrollX=0)},Timeline.prototype.onDocumentMouseMove=function(t){var e=t.layerX;if(t.layerY,this.draggingTime){this.time=this.xToTime(e);var i=this.findVideoDuration();this.time<0&&(this.time=0),this.time>i&&(this.time=i),this.prevTime=this.time-FRAME_DELTA,document.getElementById(this.videoId).currentTime=this.time}if(this.draggingKeys){for(var s=0;s<this.selectedKeys.length;s++){var h=this.selectedKeys[s];h.time=Math.max(0,this.xToTime(e)),this.sortTrackKeys(h.track),this.rebuildSelectedTracks()}this.cancelKeyClick=!0,this.timeScrollThumbPos=this.timeScrollX*(this.timeScrollWidth-this.timeScrollThumbWidth)}this.draggingTimeScale&&(this.timeScale=Math.max(.01,Math.min((this.trackLabelWidth-e)/this.trackLabelWidth,1)))},Timeline.prototype.onMouseUp=function(t){this.draggingTime&&(this.draggingTime=!1),this.draggingKeys&&(this.draggingKeys=!1),this.draggingTracksScrollThumb&&(this.draggingTracksScrollThumb=!1),this.draggingTimeScale&&(this.draggingTimeScale=!1),this.draggingTimeScrollThumb&&(this.draggingTimeScrollThumb=!1)},Timeline.prototype.onMouseClick=function(t){this.contextMenuHide(),t.layerX<1*this.headerHeight-0&&t.layerY<this.headerHeight&&this.play(),t.layerX>1*this.headerHeight-0&&t.layerX<2*this.headerHeight-4&&t.layerY<this.headerHeight&&this.pause(),t.layerX>2*this.headerHeight-4&&t.layerX<3*this.headerHeight-8&&t.layerY<this.headerHeight&&this.stop(),t.layerX>3*this.headerHeight-8&&t.layerX<4*this.headerHeight-12&&t.layerY<this.headerHeight&&(this.clickedTrackIndex=-1,this.currentAnnotationIndex=-1,this.annotationFormLoad()),!this.draggingTimeScrollThumb&&t.layerX>this.trackLabelWidth&&t.layerY>this.canvasHeight-this.timeScrollHeight&&(this.timeScrollThumbPos=t.layerX-this.trackLabelWidth,this.timeScrollThumbPos<0&&(this.timeScrollThumbPos=0),this.timeScrollThumbPos+this.timeScrollThumbWidth>this.timeScrollWidth&&(this.timeScrollThumbPos=Math.max(0,this.timeScrollWidth-this.timeScrollThumbWidth)),this.timeScrollWidth-this.timeScrollThumbWidth>0?this.timeScrollX=this.timeScrollThumbPos/(this.timeScrollWidth-this.timeScrollThumbWidth):this.timeScrollX=0),!this.draggingTracksScrollThumb&&t.layerX>this.canvas.width-this.tracksScrollWidth&&t.layerY>this.headerHeight&&t.layerY<this.canvasHeight-this.timeScrollHeight&&(this.tracksScrollThumbPos=t.layerY-this.headerHeight,this.tracksScrollThumbPos<0&&(this.tracksScrollThumbPos=0),this.tracksScrollThumbPos+this.tracksScrollThumbHeight>this.tracksScrollHeight&&(this.tracksScrollThumbPos=Math.max(0,this.tracksScrollHeight-this.tracksScrollThumbHeight)),this.tracksScrollHeight-this.tracksScrollThumbHeight>0?this.tracksScrollY=this.tracksScrollThumbPos/(this.tracksScrollHeight-this.tracksScrollThumbHeight):this.tracksScrollY=0),this.draggingTime&&(this.draggingTime=!1),this.draggingKeys&&(this.draggingKeys=!1),this.draggingTracksScrollThumb&&(this.draggingTracksScrollThumb=!1),this.draggingTimeScale&&(this.draggingTimeScale=!1),this.draggingTimeScrollThumb&&(this.draggingTimeScrollThumb=!1)},Timeline.prototype.onDoubleMouseClick=function(t){t.layerX>this.trackLabelWidth&&t.layerY>this.canvasHeight-this.timeScrollHeight&&(this.timeScrollThumbPos=t.layerX-this.trackLabelWidth,this.timeScrollThumbPos<0&&(this.timeScrollThumbPos=0),this.timeScrollThumbPos+this.timeScrollThumbWidth>this.timeScrollWidth&&(this.timeScrollThumbPos=Math.max(0,this.timeScrollWidth-this.timeScrollThumbWidth)),this.timeScrollWidth-this.timeScrollThumbWidth>0?this.timeScrollX=this.timeScrollThumbPos/(this.timeScrollWidth-this.timeScrollThumbWidth):this.timeScrollX=0)},Timeline.prototype.drawTrack=function(t,e,i){this.drawLine(0,e,this.canvas.width,e,"#FFFFFF");for(var s=0;s<t?.annotations?.length;s++)if(!this.hideTracksOnSelection||-1===this.currentAnnotationIndex||this.currentAnnotationIndex===s||this.clickedTrackIndex!=t.index){var h=t.annotations[s];this.drawAnnotaion(t,h,e,s)}this.currentTrackIndex==t.index?this.drawRect(0,e-this.trackLabelHeight,this.trackLabelWidth,this.trackLabelHeight+2,"#88FFFF"):this.drawRect(0,e-this.trackLabelHeight,this.trackLabelWidth,this.trackLabelHeight+2,"#FFFFFF"),this.c.fillStyle="#000000",this.drawLine(0,e-this.trackLabelHeight,this.trackLabelWidth,e-this.trackLabelHeight,"#BBBBBB"),this.c.fillStyle="black",this.c.font="12px Arial",this.c.fillText(`${t.name} (${i})`,5,e-this.trackLabelHeight/4)},Timeline.prototype.drawAnnotaion=function(t,e,i,s){if(e){var h=this.timeToX(e.startTime),n=this.timeToX(e.endTime),a=this.trackLabelHeight/2,o=i-this.trackLabelHeight/2;this.drawRect(h,o,n-h,1.2*a,"#ffffff"),this.c.fillStyle="black",this.c.font="12px Arial";var l=this.c.measureText(e.text).width;h+l>n?this.c.fillText(e.text,h,o+a,n-h):this.c.fillText(e.text,h+(n-h-l)/2,o+a),a*=1.2,this.drawLine(h,o,h,o+a,"red"),this.drawLine(n,o,n,o+a,"red"),this.currentAnnotationIndex==s&&this.clickedTrackIndex==t.index&&(this.drawLine(h,o,n,o,"red"),this.drawLine(h,o+a,n,o+a,"red"),(this.loadedAnnotationIndex!==s||this.loadedAnnotationTrackIndex!==t.index)&&(this.annotationFormLoad(this.clickedTrackIndex,s),this.loadedAnnotationIndex=s,this.loadedAnnotationTrackIndex=this.clickedTrackIndex))}},Timeline.prototype.drawLine=function(t,e,i,s,h){this.c.strokeStyle=h,this.c.beginPath(),this.c.moveTo(t+.5,e+.5),this.c.lineTo(i+.5,s+.5),this.c.stroke()},Timeline.prototype.drawRect=function(t,e,i,s,h){this.c.fillStyle=h,this.c.fillRect(t,e,i,s)},Timeline.prototype.drawCenteredRect=function(t,e,i,s,h){this.c.fillStyle=h,this.c.fillRect(t-i/2,e-s/2,i,s)},Timeline.prototype.drawRombus=function(t,e,i,s,h,n,a,o){this.c.fillStyle=h,o&&(this.c.lineWidth=2,this.c.strokeStyle=o,this.c.beginPath(),this.c.moveTo(t,e-s/2),this.c.lineTo(t+i/2,e),this.c.lineTo(t,e+s/2),this.c.lineTo(t-i/2,e),this.c.lineTo(t,e-s/2),this.c.stroke(),this.c.lineWidth=1),n&&(this.c.beginPath(),this.c.moveTo(t,e-s/2),this.c.lineTo(t-i/2,e),this.c.lineTo(t,e+s/2),this.c.fill()),a&&(this.c.beginPath(),this.c.moveTo(t,e-s/2),this.c.lineTo(t+i/2,e),this.c.lineTo(t,e+s/2),this.c.fill())};const FRAME_DELTA=1/30,SEEK_MODE_FRAMES=0,SEEK_MODE_SECONDS=1;